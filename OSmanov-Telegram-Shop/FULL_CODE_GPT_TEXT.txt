–í–æ—Ç –º–æ—ë React TypeScript + Node JS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

/backend/database/schema.sql:
-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE
    IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        balance DECIMAL(15, 2) DEFAULT 0.00,
        total_spent DECIMAL(15, 2) DEFAULT 0.00,
        join_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

-- –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
CREATE TABLE
    IF NOT EXISTS transactions (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users (id),
        amount DECIMAL(15, 2) NOT NULL,
        type VARCHAR(20) CHECK (type IN ('deposit', 'withdrawal', 'purchase')),
        status VARCHAR(20) CHECK (
            status IN ('pending', 'completed', 'failed', 'cancelled')
        ),
        payment_method VARCHAR(50),
        payment_details JSONB,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫—É–ø–æ–∫
CREATE TABLE
    IF NOT EXISTS purchases (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users (id),
        custom_id VARCHAR(100), -- ‚Üê –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç—É –∫–æ–ª–æ–Ω–∫—É
        service_id INTEGER,
        service_name VARCHAR(255) NOT NULL,
        quantity INTEGER DEFAULT 1, -- ‚Üê –¥–æ–±–∞–≤–∏—Ç—å
        amount DECIMAL(15, 2) NOT NULL,
        total_price DECIMAL(15, 2), -- ‚Üê –¥–æ–±–∞–≤–∏—Ç—å
        currency VARCHAR(10) DEFAULT 'USD',
        status VARCHAR(20) CHECK (status IN ('completed', 'pending', 'failed')) DEFAULT 'completed',
        pins JSONB, -- ‚Üê –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è PIN –∫–æ–¥–æ–≤
        data TEXT, -- ‚Üê –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        purchase_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_users_email ON users (email);

CREATE INDEX IF NOT EXISTS idx_transactions_user_id ON transactions (user_id);

CREATE INDEX IF NOT EXISTS idx_purchases_user_id ON purchases (user_id);

-- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
INSERT INTO
    users (
        id,
        username,
        email,
        password_hash,
        balance,
        total_spent
    )
VALUES
    (
        1,
        'djosmanov',
        'djosmanov@example.com',
        'hashed_password',
        100000.00,
        0.00
    ) ON CONFLICT (id) DO
UPDATE
SET
    username = EXCLUDED.username,
    email = EXCLUDED.email,
    balance = EXCLUDED.balance,
    total_spent = EXCLUDED.total_spent;

-- INSERT INTO
--     purchases (
--         user_id,
--         service_id,
--         service_name,
--         amount,
--         currency,
--         status,
--         purchase_date
--     )
-- VALUES
--     (
--         1,
--         1,
--         'Steam Gift Card $50',
--         4500.00,
--         'USD',
--         'completed',
--         '2024-03-15 14:30:00'
--     ),
--     (
--         1,
--         2,
--         'PlayStation Network $20',
--         1800.00,
--         'USD',
--         'completed',
--         '2024-03-10 10:15:00'
--     ),
--     (
--         1,
--         3,
--         'Xbox Live Gold 3 Months',
--         2500.00,
--         'USD',
--         'completed',
--         '2024-03-05 16:45:00'
--     ),
--     (
--         1,
--         4,
--         'Spotify Premium 1 Year',
--         12000.00,
--         'USD',
--         'completed',
--         '2024-02-28 09:20:00'
--     ),
--     (
--         1,
--         5,
--         'Netflix Gift Card $30',
--         2700.00,
--         'USD',
--         'completed',
--         '2024-02-20 11:30:00'
--     ) ON CONFLICT DO NOTHING;

/backend/src/controllers/cardlink.controller.ts:
// backend/src/controllers/cardlink.controller.ts
import { Request, Response } from 'express';
import { cardLinkService } from '../services/cardlink.service';
import { userService } from '../services/user.service';
import { CardLinkCreatePaymentRequest, CardLinkWebhookPayload } from '../types/cardlink.types';

export class CardLinkController {
  async createPayment(req: Request, res: Response): Promise<void> {
    try {
      const { amount, order_id, description, user_id, success_url, fail_url }: CardLinkCreatePaymentRequest = req.body;

      if (!amount || amount <= 0) {
        res.status(400).json({
          status: 'error',
          message: 'Invalid amount'
        });
        return;
      }

      if (!order_id) {
        res.status(400).json({
          status: 'error',
          message: 'Order ID is required'
        });
        return;
      }

      const paymentParams = {
        amount,
        shop_id: process.env.CARD_LINK_SHOP_ID || '',
        order_id,
        description: description || `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ ${amount} ‚ÇΩ`,
        payment_type: 'normal',
        currency_in: 'RUB',
        custom: `user_${user_id}`,
        payer_pays_commission: 1,
        name: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
        ttl: 3600, // 1 —á–∞—Å
        success_url: `${process.env.FRONTEND_URL}`,
        fail_url: `${process.env.FRONTEND_URL}`,
        payment_method: 'SBP'
      };

      const paymentResult = await cardLinkService.createPayment(paymentParams);

      if (paymentResult.success) {
        res.json({
          status: 'success',
          data: paymentResult
        });
      } else {
        res.status(400).json({
          status: 'error',
          message: paymentResult.error || 'Failed to create payment'
        });
      }
    } catch (error) {
      console.error('Error creating CardLink payment:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to create payment'
      });
    }
  }

  async checkPaymentStatus(req: Request, res: Response): Promise<void> {
    try {
      const { bill_id } = req.query;

      if (!bill_id) {
        res.status(400).json({
          status: 'error',
          message: 'Bill ID is required'
        });
        return;
      }

      const status = await cardLinkService.checkPaymentStatus(bill_id as string);

      if (status.success) {
        res.json({
          status: 'success',
          data: status
        });
      } else {
        res.status(400).json({
          status: 'error',
          message: status.error || 'Failed to check payment status'
        });
      }
    } catch (error) {
      console.error('Error checking payment status:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to check payment status'
      });
    }
  }

  async handleWebhook(req: Request, res: Response): Promise<void> {
    try {
      const payload: CardLinkWebhookPayload = req.body;
      
      console.log('CardLink webhook received:', payload);

      // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (—Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
      // if (!this.verifySignature(payload)) {
      //   res.status(400).send('Invalid signature');
      //   return;
      // }

      if (payload.Status === 'SUCCESS') {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ custom –ø–æ–ª—è
        const userIdMatch = payload.custom?.match(/user_(\d+)/);
        if (userIdMatch) {
          const userId = parseInt(userIdMatch[1]);
          const amount = parseFloat(payload.OutSum);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          await userService.updateUserBalance(userId, amount);
          
          // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂
          console.log(`Payment webhook: User ${userId}, Amount: ${amount}, Payment ID: ${payload.TrsId}`);
        }
      }

      // –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ–º 200 OK –Ω–∞ webhook
      res.status(200).send('OK');
    } catch (error) {
      console.error('Error processing CardLink webhook:', error);
      res.status(500).send('Error');
    }
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏
  private verifySignature(payload: CardLinkWebhookPayload): boolean {
    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ CardLink
    // strtoupper(md5($OutSum . ":" . $InvId . ":" . $apiToken))
    return true; // –í—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  }
}

export const cardLinkController = new CardLinkController();


/backend/src/controllers/gifts.controller.ts:
import { Request, Response } from 'express';
import { giftsApiService } from '../services/giftsApi.service';
import { userService } from '../services/user.service';
import { uuid } from 'uuidv4';
import { CheckoutRequest, CheckoutResponse } from '../types/api.types';

export class GiftsController {
  async getCategories(req: Request, res: Response): Promise<void> {
    try {
      const token = await giftsApiService.getAuthToken();
      const categories = await giftsApiService.getCategories(token);
      
      res.json({
        status: 'success',
        data: categories
      });
    } catch (error) {
      console.error('Error fetching categories:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch categories'
      });
    }
  }

  async getAllServices(req: Request, res: Response): Promise<void> {
    try {
      const token = await giftsApiService.getAuthToken();
      const services = await giftsApiService.getAllServices(token);
      
      res.json({
        status: 'success',
        data: services
      });
    } catch (error) {
      console.error('Error fetching services:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch services'
      });
    }
  }

  async getAuthToken(req: Request, res: Response): Promise<void> {
    try {
      const token = await giftsApiService.getAuthToken();
      
      res.json({
        status: 'success',
        data: { token }
      });
    } catch (error) {
      console.error('Error getting auth token:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to get auth token'
      });
    }
  }

  async getServicesByCategory(req: Request, res: Response): Promise<void> {
    try {
      const { category_id } = req.query;
      
      if (!category_id) {
        res.status(400).json({
          status: 'error',
          message: 'Category ID is required'
        });
        return;
      }

      const token = await giftsApiService.getAuthToken();
      const services = await giftsApiService.getServicesByCategory(
        token, 
        parseInt(category_id as string)
      );
      
      res.json({
        status: 'success',
        data: services
      });
    } catch (error) {
      console.error('Error fetching services by category:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch services by category'
      });
    }
  }

  async getOrderInfo(req: Request, res: Response): Promise<void> {
    try {
      const { custom_id } = req.body;

      if (!custom_id) {
        res.status(400).json({
          status: 'error',
          message: 'custom_id is required'
        });
        return;
      }

      console.log(`üì¶ Fetching order info for custom_id: ${custom_id}`);
      
      const token = await giftsApiService.getAuthToken();
      const orderInfo = await giftsApiService.getOrderInfo(token, custom_id);
      
      console.log(`‚úÖ Order info retrieved for ${custom_id}:`, {
        status: orderInfo.status,
        product: orderInfo.product,
        status_message: orderInfo.status_message
      });
      
      res.json({
        status: 'success',
        data: orderInfo
      });
    } catch (error) {
      console.error('‚ùå Error fetching order info:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch order information'
      });
    }
  }

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–∫–∞–∑–∞—Ö
  async getMultipleOrdersInfo(req: Request, res: Response): Promise<void> {
    try {
      const { custom_ids } = req.body;

      if (!custom_ids || !Array.isArray(custom_ids)) {
        res.status(400).json({
          status: 'error',
          message: 'custom_ids array is required'
        });
        return;
      }

      console.log(`üì¶ Fetching info for ${custom_ids.length} orders`);
      
      const token = await giftsApiService.getAuthToken();
      const ordersPromises = custom_ids.map(custom_id => 
        giftsApiService.getOrderInfo(token, custom_id)
      );
      
      const orders = await Promise.all(ordersPromises);
      
      console.log(`‚úÖ Successfully retrieved info for ${orders.length} orders`);
      
      res.json({
        status: 'success',
        data: orders
      });
    } catch (error) {
      console.error('‚ùå Error fetching multiple orders info:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch orders information'
      });
    }
  }

  async createOrder(req: Request, res: Response): Promise<void> {
    try {
      const { service_id, quantity, data, user_id, service_name, price } = req.body;

      if (!service_id || !quantity || !user_id || !service_name || !price) {
        res.status(400).json({
          status: 'error',
          message: 'service_id, quantity, user_id, service_name, and price are required'
        });
        return;
      }

      const custom_id = uuid();
      console.log(`üÜï Creating order for user ${user_id}, service ${service_name}`);

      const token = await giftsApiService.getAuthToken();
      
      const orderData = {
        service_id: parseInt(service_id),
        quantity: parseFloat(quantity),
        custom_id,
        data: data || ''
      };

      const order = await giftsApiService.createOrder(token, orderData);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
      await userService.savePurchaseWithDetails({
        user_id: parseInt(user_id),
        custom_id,
        service_id: parseInt(service_id),
        service_name,
        quantity: parseFloat(quantity),
        total_price: parseFloat(price) * parseFloat(quantity),
        status: 'pending'
      });

      console.log(`‚úÖ Order created: ${custom_id}, total: ${order.total}`);
      
      res.json({
        status: 'success',
        data: {
          ...order,
          service_name,
          user_id: parseInt(user_id)
        }
      });
    } catch (error) {
      console.error('‚ùå Error creating order:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to create order'
      });
    }
  }

  async payOrder(req: Request, res: Response): Promise<void> {
    try {
      const { custom_id, user_id } = req.body;

      if (!custom_id || !user_id) {
        res.status(400).json({
          status: 'error',
          message: 'custom_id and user_id are required'
        });
        return;
      }

      console.log(`üí≥ Paying for order: ${custom_id}`);

      const token = await giftsApiService.getAuthToken();
      const paymentResult = await giftsApiService.payOrder(token, custom_id);
      
      console.log('üí∞ Payment result:', paymentResult);
      
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
      const orderInfo = await giftsApiService.getOrderInfo(token, custom_id);
      
      console.log('üì¶ Order info:', orderInfo);
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –ë–î
      let dbStatus: 'pending' | 'completed' | 'failed' = 'pending';
      if (orderInfo.status === 2) dbStatus = 'completed';
      else if (orderInfo.status === 3) dbStatus = 'failed';

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      await userService.updatePurchaseStatus(
        custom_id, 
        dbStatus,
        orderInfo.pins,
        orderInfo.data
      );

      console.log(`‚úÖ Order paid: ${custom_id}, status: ${orderInfo.status_message}`);
      
      res.json({
        status: 'success',
        data: {
          payment: paymentResult,
          order: orderInfo
        }
      });
    } catch (error) {
      console.error('‚ùå Error paying order:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to pay order'
      });
    }
  }

  async checkout(req: Request, res: Response): Promise<void> {
    try {
      const { user_id, items }: CheckoutRequest = req.body;

      if (!user_id || !items || !Array.isArray(items) || items.length === 0) {
        res.status(400).json({
          status: 'error',
          message: 'user_id and items array are required'
        });
        return;
      }

      console.log(`üõí Processing checkout for user ${user_id} with ${items.length} items`);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userBalance = await userService.getUserBalance(parseInt(user_id));
      const totalAmount = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      if (userBalance < totalAmount) {
        res.status(400).json({
          status: 'error',
          message: `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç—É!`
        });
        return;
      }

      const token = await giftsApiService.getAuthToken();
      const results: CheckoutResponse[] = [];

      // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—É–º–º—É —Å –±–∞–ª–∞–Ω—Å–∞
      await userService.deductUserBalance(parseInt(user_id), totalAmount);

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ
      for (const item of items) {
        try {
          const custom_id = uuid();
          
          // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
          const order = await giftsApiService.createOrder(token, {
            service_id: item.service_id,
            quantity: item.quantity,
            custom_id,
            data: item.data || ''
          });

          // –û–ø–ª–∞—á–∏–≤–∞–µ–º –∑–∞–∫–∞–∑
          await giftsApiService.payOrder(token, custom_id);
          
          // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
          const orderInfo = await giftsApiService.getOrderInfo(token, custom_id);
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          let dbStatus: 'pending' | 'completed' | 'failed' = 'pending';
          if (orderInfo.status === 2) dbStatus = 'completed';
          else if (orderInfo.status === 3) dbStatus = 'failed';

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
          await userService.savePurchaseWithDetails({
            user_id: parseInt(user_id),
            custom_id,
            service_id: item.service_id,
            service_name: item.service_name,
            quantity: item.quantity,
            total_price: item.price * item.quantity,
            status: dbStatus,
            pins: orderInfo.pins,
            data: orderInfo.data
          });

          results.push({
            success: orderInfo.status === 2,
            custom_id,
            service_id: item.service_id,
            service_name: item.service_name,
            status: orderInfo.status,
            status_message: orderInfo.status_message,
            pins: orderInfo.pins,
            data: orderInfo.data
          });

          console.log(`‚úÖ Processed: ${item.service_name}, status: ${orderInfo.status_message}`);

        } catch (itemError) {
          console.error(`‚ùå Error processing ${item.service_name}:`, itemError);
          results.push({
            success: false,
            custom_id: '',
            service_id: item.service_id,
            service_name: item.service_name,
            status: 3,
            status_message: 'Processing failed',
            error: itemError instanceof Error ? itemError.message : 'Unknown error'
          });
        }
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–µ—É–¥–∞—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
      const failedItems = results.filter(item => !item.success);
      if (failedItems.length > 0) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å–≥–∏ –∑–∞ –Ω–µ—É–¥–∞—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
        const refundAmount = failedItems.reduce((sum, item) => {
          const originalItem = items.find(i => i.service_id === item.service_id);
          return sum + (originalItem ? originalItem.price * originalItem.quantity : 0);
        }, 0);

        if (refundAmount > 0) {
          await userService.updateUserBalance(parseInt(user_id), refundAmount);
          console.log(`üí∏ Refunded ${refundAmount} for ${failedItems.length} failed items`);
        }
      }

      res.json({
        status: 'success',
        data: {
          results,
          total_processed: results.filter(r => r.success).length,
          total_failed: failedItems.length,
          total_amount: totalAmount
        }
      });

    } catch (error) {
      console.error('‚ùå Error during checkout:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to process checkout'
      });
    }
  }

  async getOrderInfoByCustomId(req: Request, res: Response): Promise<void> {
    try {
      const { custom_id } = req.body;

      if (!custom_id) {
        res.status(400).json({
          status: 'error',
          message: 'custom_id is required'
        });
        return;
      }

      console.log(`üì¶ Fetching detailed order info for: ${custom_id}`);
      
      const token = await giftsApiService.getAuthToken();
      const orderInfo = await giftsApiService.getOrderInfo(token, custom_id);
      
      console.log(`‚úÖ Detailed order info retrieved for ${custom_id}`);
      
      res.json({
        status: 'success',
        data: orderInfo
      });
    } catch (error) {
      console.error('‚ùå Error fetching detailed order info:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch detailed order information'
      });
    }
  }
}

export const giftsController = new GiftsController();


/backend/src/controllers/user.controller.ts:
import { Request, Response } from 'express';
import { userService } from '../services/user.service';

export class UserController {
  async getProfile(req: Request, res: Response): Promise<void> {
    try {
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç auth middleware, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–∏—Ç user.id –≤ req
      const userId = parseInt(req.params.userId) || 1; // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID 1 –¥–ª—è —Ç–µ—Å—Ç–∞
      
      const profile = await userService.getUserProfile(userId);
      
      res.json({
        status: 'success',
        data: profile
      });
    } catch (error) {
      console.error('Error fetching user profile:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch user profile'
      });
    }
  }

  async updateBalance(req: Request, res: Response): Promise<void> {
    try {
      const userId = parseInt(req.params.userId) || 1; // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID 1 –¥–ª—è —Ç–µ—Å—Ç–∞
      const { amount, payment_method, payment_details } = req.body;

      if (!amount || amount <= 0) {
        res.status(400).json({
          status: 'error',
          message: 'Invalid amount'
        });
        return;
      }

      const updatedUser = await userService.updateUserBalance(userId, amount);
      
      res.json({
        status: 'success',
        data: {
          user: updatedUser,
          added_amount: amount
        }
      });
    } catch (error) {
      console.error('Error updating balance:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to update balance'
      });
    }
  }

  async getPurchaseHistory(req: Request, res: Response): Promise<void> {
    try {
      const userId = parseInt(req.params.userId) || 1;
      const limit = parseInt(req.query.limit as string) || 10;
      
      const purchases = await userService.getUserPurchases(userId, limit);
      
      res.json({
        status: 'success',
        data: purchases
      });
    } catch (error) {
      console.error('Error fetching purchase history:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch purchase history'
      });
    }
  }

  async getTransactionHistory(req: Request, res: Response): Promise<void> {
    try {
      const userId = parseInt(req.params.userId) || 1;
      const limit = parseInt(req.query.limit as string) || 20;
      
      const transactions = await userService.getTransactionHistory(userId, limit);
      
      res.json({
        status: 'success',
        data: transactions
      });
    } catch (error) {
      console.error('Error fetching transaction history:', error);
      res.status(500).json({
        status: 'error',
        message: 'Failed to fetch transaction history'
      });
    }
  }
}

export const userController = new UserController();


/backend/src/database/db.ts:
import { Pool } from 'pg';
import dotenv from 'dotenv';

dotenv.config();

const pool = new Pool({
  user: process.env.DB_USER || 'postgres',
  host: process.env.DB_HOST || 'localhost',
  database: process.env.DB_NAME || 'gifts_app',
  password: process.env.DB_PASSWORD || 'password',
  port: parseInt(process.env.DB_PORT || '5432'),
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 20000, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è Docker
});

// –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ä–µ—Ç—Ä–∞—è–º–∏
const testConnection = async () => {
  let retries = 5;
  while (retries) {
    try {
      const client = await pool.connect();
      console.log('‚úÖ Connected to PostgreSQL database');
      client.release();
      break;
    } catch (err) {
      console.log(`‚ùå PostgreSQL connection failed, retries left: ${retries}`);
      retries -= 1;
      await new Promise(res => setTimeout(res, 5000));
    }
  }
};

testConnection();

pool.on('error', (err) => {
  console.error('‚ùå PostgreSQL connection error:', err);
});

export const query = (text: string, params?: any[]) => {
  return pool.query(text, params);
};

export const getClient = () => {
  return pool.connect();
};

export default pool;


/backend/src/middleware/logger.ts:
import { Request, Response, NextFunction } from 'express';

export const requestLogger = (req: Request, res: Response, next: NextFunction) => {
  const timestamp = new Date().toISOString();
  const method = req.method;
  const url = req.url;
  const ip = req.ip || req.connection.remoteAddress;
  
  console.log(`üì® [${timestamp}] ${method} ${url} - IP: ${ip}`);
  
  // –õ–æ–≥–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è POST/PUT/PATCH
  if (['POST', 'PUT', 'PATCH'].includes(method) && req.body) {
    console.log('üì¶ Request Body:', JSON.stringify(req.body, null, 2));
  }
  
  // –õ–æ–≥–∏—Ä—É–µ–º query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  if (Object.keys(req.query).length > 0) {
    console.log('üîç Query Params:', req.query);
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ send
  const originalSend = res.send;
  
  // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
  res.send = function(body) {
    const contentLength = res.get('Content-Length') || Buffer.byteLength(body as string || '');
    console.log(`üì§ [${timestamp}] ${method} ${url} - Status: ${res.statusCode} - Length: ${contentLength}`);
    
    return originalSend.call(this, body);
  };
  
  next();
};


/backend/src/routes/cardlink.routes.ts:
// backend/src/routes/cardlink.routes.ts
import { Router } from 'express';
import { cardLinkController } from '../controllers/cardlink.controller';

const router = Router();

router.post('/create-payment', cardLinkController.createPayment.bind(cardLinkController));
router.get('/check-status', cardLinkController.checkPaymentStatus.bind(cardLinkController));
router.post('/webhook', cardLinkController.handleWebhook.bind(cardLinkController));

export const cardLinkRoutes = router;


/backend/src/routes/gifts.routes.ts:
import { Router } from 'express';
import { giftsController } from '../controllers/gifts.controller';

const router = Router();

router.get('/categories', giftsController.getCategories.bind(giftsController));
router.get('/services', giftsController.getAllServices.bind(giftsController));
router.get('/token', giftsController.getAuthToken.bind(giftsController));
router.get('/services/by-category', giftsController.getServicesByCategory.bind(giftsController));

router.post('/order-info', giftsController.getOrderInfo.bind(giftsController));
router.post('/orders-info', giftsController.getMultipleOrdersInfo.bind(giftsController));

router.post('/create-order', giftsController.createOrder.bind(giftsController));
router.post('/pay-order', giftsController.payOrder.bind(giftsController));
router.post('/checkout', giftsController.checkout.bind(giftsController));

router.post('/order-info-by-custom-id', giftsController.getOrderInfoByCustomId.bind(giftsController));

export const giftsRoutes = router;


/backend/src/routes/user.routes.ts:
import { Router } from 'express';
import { userController } from '../controllers/user.controller';

const router = Router();

router.get('/profile/:userId', userController.getProfile.bind(userController));
router.post('/balance/:userId', userController.updateBalance.bind(userController));
router.get('/purchases/:userId', userController.getPurchaseHistory.bind(userController));
router.get('/transactions/:userId', userController.getTransactionHistory.bind(userController));

export const userRoutes = router;


/backend/src/services/cardlink.service.ts:
// backend/src/services/cardlink.service.ts
import axios from 'axios';
import * as qs from 'qs';

export interface CardLinkPaymentRequest {
  amount: number;
  shop_id: string;
  order_id: string;
  description?: string;
  payment_type?: string;
  currency_in?: string;
  custom?: string;
  payer_pays_commission?: number;
  name?: string;
  ttl?: number;
  success_url?: string;
  fail_url?: string;
  payment_method?: string;
}

export interface CardLinkPaymentResponse {
  success: boolean;
  link_url?: string;
  link_page_url?: string;
  bill_id?: string;
  error?: string;
}

export interface PaymentStatusResponse {
  success: boolean;
  id?: string;
  bill_id?: string;
  status?: string;
  amount?: number;
  is_paid?: boolean;
  is_failed?: boolean;
  is_processing?: boolean;
  error?: string;
}

export class CardLinkService {
  private apiToken: string;
  private baseUrl: string;

  constructor() {
    this.apiToken = process.env.CARD_LINK_TOKEN || '';
    this.baseUrl = process.env.CARD_LINK_BASE_URL || 'https://cardlink.link/api/v1';
  }

  async createPayment(params: CardLinkPaymentRequest): Promise<CardLinkPaymentResponse> {
    try {
      const url = `${this.baseUrl}/bill/create`;

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ form-urlencoded —Ñ–æ—Ä–º–∞—Ç
      const formData = qs.stringify(params);

      console.log('Sending to CardLink:', {
        url,
        data: formData,
        shop_id: params.shop_id,
        amount: params.amount
      });
      
      const response = await axios.post(url, formData, {
        headers: {
          'Authorization': `Bearer ${this.apiToken}`,
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      });

      return response.data;
    } catch (error: any) {
      console.error('CardLink API error:', error.response?.data || error.message);
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  }

  async checkPaymentStatus(billId: string): Promise<PaymentStatusResponse> {
    try {
      const url = `${this.baseUrl}/bill/status`;
      
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${this.apiToken}`
        },
        params: {
          id: billId
        }
      });

      const result = response.data;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É–¥–æ–±–Ω—ã–µ —Ñ–ª–∞–≥–∏ —Å—Ç–∞—Ç—É—Å–∞
      if (result.success) {
        result.is_paid = result.status === 'SUCCESS';
        result.is_failed = result.status === 'FAIL';
        result.is_processing = ['NEW', 'PROCESS'].includes(result.status);
      }

      return result;
    } catch (error: any) {
      console.error('CardLink API error:', error.response?.data || error.message);
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  }

  async checkPaymentStatusByPaymentId(paymentId: string): Promise<PaymentStatusResponse> {
    try {
      const url = `${this.baseUrl}/payment/status`;
      
      const response = await axios.get(url, {
        headers: {
          'Authorization': `Bearer ${this.apiToken}`
        },
        params: {
          id: paymentId
        }
      });

      const result = response.data;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É–¥–æ–±–Ω—ã–µ —Ñ–ª–∞–≥–∏ —Å—Ç–∞—Ç—É—Å–∞
      if (result.success) {
        result.is_paid = result.status === 'SUCCESS';
        result.is_failed = result.status === 'FAIL';
        result.is_processing = ['NEW', 'PROCESS'].includes(result.status);
      }

      return result;
    } catch (error: any) {
      console.error('CardLink API error:', error.response?.data || error.message);
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  }
}

export const cardLinkService = new CardLinkService();


/backend/src/services/giftsApi.service.ts:
import axios, { AxiosResponse } from 'axios';
import { 
  Credentials, 
  AuthResponse, 
  Category, 
  Service, 
  OrderInfo, 
  CreateOrderRequest, 
  CreateOrderResponse, 
  PayOrderRequest, 
  PayOrderResponse 
} from '../types/api.types';

const MAIN_URL = 'https://api.ns.gifts';

const credentials: Credentials = {
  login: "djosmanov",
  password: "Th2PPs2PAi"
};

class GiftsApiService {
  private async makeRequest<T>(url: string, method: 'GET' | 'POST' = 'POST', headers?: any, data?: any): Promise<T> {
    try {
      const response: AxiosResponse<T> = await axios({
        method,
        url,
        headers,
        data,
        timeout: 10000
      });
      
      return response.data;
    } catch (error) {
      console.error(`API request failed: ${url}`, error);
      throw error;
    }
  }

  async getAuthToken(): Promise<string> {
    const url = `${MAIN_URL}/api/v1/get_token`;
    const data = {
      email: credentials.login,
      password: credentials.password
    };

    const response = await this.makeRequest<AuthResponse>(url, 'POST', undefined, data);
    return response.access_token;
  }

  async getAllServices(token: string): Promise<any> {
    const url = `${MAIN_URL}/api/v1/products/get_all_services`;
    const headers = {
      'Authorization': `Bearer ${token}`
    };

    return await this.makeRequest(url, 'POST', headers);
  }

  async getCategories(token: string): Promise<any> {
    const url = `${MAIN_URL}/api/v1/products/get_categories`;
    const headers = {
      'Authorization': `Bearer ${token}`
    };

    return await this.makeRequest(url, 'POST', headers);
  }

  async getServicesByCategory(token: string, categoryId: number): Promise<any> {
    const url = `${MAIN_URL}/api/v1/products/get_services`;
    const headers = {
      'Authorization': `Bearer ${token}`
    };
    const data = {
      category_id: categoryId
    };

    return await this.makeRequest(url, 'POST', headers, data);
  }

  async getOrderInfo(token: string, custom_id: string): Promise<OrderInfo> {
    const url = `${MAIN_URL}/api/v1/order_info`;
    const headers = {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    };
    const data = {
      custom_id
    };

    return await this.makeRequest<OrderInfo>(url, 'POST', headers, data);
  }

  async createOrder(token: string, orderData: CreateOrderRequest): Promise<CreateOrderResponse> {
    const url = `${MAIN_URL}/api/v1/create_order`;
    const headers = {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    };

    return await this.makeRequest<CreateOrderResponse>(url, 'POST', headers, orderData);
  }

  async payOrder(token: string, custom_id: string): Promise<PayOrderResponse> {
    const url = `${MAIN_URL}/api/v1/pay_order`;
    const headers = {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    };
    const data = {
      custom_id
    };

    return await this.makeRequest<PayOrderResponse>(url, 'POST', headers, data);
  }
}

export const giftsApiService = new GiftsApiService();


/backend/src/services/user.service.ts:
import { query, getClient } from '../database/db';
import { User, UserProfile, Purchase, Transaction, BalanceUpdate } from '../types/user.types';
import { CartItem, CheckoutResponse } from '../types/api.types';

export class UserService {
  async getUserById(userId: number): Promise<User | null> {
    try {
      const result = await query(
        'SELECT id, username, email, balance, total_spent, join_date, created_at, updated_at FROM users WHERE id = $1',
        [userId]
      );
      
      return result.rows[0] || null;
    } catch (error) {
      console.error('Error fetching user:', error);
      throw error;
    }
  }

  async getUserByEmail(email: string): Promise<User | null> {
    try {
      const result = await query(
        'SELECT id, username, email, balance, total_spent, join_date, created_at, updated_at FROM users WHERE email = $1',
        [email]
      );
      
      return result.rows[0] || null;
    } catch (error) {
      console.error('Error fetching user by email:', error);
      throw error;
    }
  }

  async getUserPurchases(userId: number, limit: number = 10): Promise<Purchase[]> {
    try {
      const result = await query(
        `SELECT id, user_id, service_id, service_name, amount, currency, status, purchase_date, created_at, custom_id
         FROM purchases 
         WHERE user_id = $1 
         ORDER BY purchase_date DESC 
         LIMIT $2`,
        [userId, limit]
      );
      
      return result.rows;
    } catch (error) {
      console.error('Error fetching user purchases:', error);
      throw error;
    }
  }

  async getUserProfile(userId: number): Promise<UserProfile> {
    try {
      const user = await this.getUserById(userId);
      if (!user) {
        throw new Error('User not found');
      }

      const purchases = await this.getUserPurchases(userId);
      
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —É—Å–ø–µ—à–Ω—ã–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
      const statsResult = await query(
        `SELECT COUNT(*) as successful_count 
         FROM purchases 
         WHERE user_id = $1 AND status = 'completed'`,
        [userId]
      );

      const successfulTransactions = parseInt(statsResult.rows[0].successful_count);

      return {
        user,
        purchases,
        totalPurchases: purchases.length,
        successfulTransactions
      };
    } catch (error) {
      console.error('Error fetching user profile:', error);
      throw error;
    }
  }

  async updateUserBalance(userId: number, amount: number): Promise<User> {
    const client = await getClient();
    
    try {
      await client.query('BEGIN');

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const result = await client.query(
        'UPDATE users SET balance = balance + $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2 RETURNING *',
        [amount, userId]
      );

      if (result.rows.length === 0) {
        throw new Error('User not found');
      }

      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      await client.query(
        `INSERT INTO transactions (user_id, amount, type, status, payment_method) 
         VALUES ($1, $2, 'deposit', 'completed', 'balance_topup')`,
        [userId, amount]
      );

      await client.query('COMMIT');
      
      return result.rows[0];
    } catch (error) {
      await client.query('ROLLBACK');
      console.error('Error updating user balance:', error);
      throw error;
    } finally {
      client.release();
    }
  }

  async createPurchase(userId: number, purchaseData: Omit<Purchase, 'id' | 'user_id' | 'created_at'>): Promise<Purchase> {
    const client = await getClient();
    
    try {
      await client.query('BEGIN');

      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–∫—É–ø–∫–µ
      const purchaseResult = await client.query(
        `INSERT INTO purchases (user_id, service_id, service_name, amount, currency, status, purchase_date) 
         VALUES ($1, $2, $3, $4, $5, $6, $7) 
         RETURNING *`,
        [
          userId,
          purchaseData.service_id,
          purchaseData.service_name,
          purchaseData.amount,
          purchaseData.currency || 'USD',
          purchaseData.status,
          purchaseData.purchase_date || new Date().toISOString()
        ]
      );

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –æ–±—â—É—é —Å—É–º–º—É –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–≥–æ
      await client.query(
        `UPDATE users 
         SET balance = balance - $1, 
             total_spent = total_spent + $1,
             updated_at = CURRENT_TIMESTAMP 
         WHERE id = $2`,
        [purchaseData.amount, userId]
      );

      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      await client.query(
        `INSERT INTO transactions (user_id, amount, type, status, payment_method) 
         VALUES ($1, $2, 'purchase', 'completed', 'balance')`,
        [userId, purchaseData.amount]
      );

      await client.query('COMMIT');
      
      return purchaseResult.rows[0];
    } catch (error) {
      await client.query('ROLLBACK');
      console.error('Error creating purchase:', error);
      throw error;
    } finally {
      client.release();
    }
  }

  async getTransactionHistory(userId: number, limit: number = 20): Promise<any[]> {
    try {
      const result = await query(
        `SELECT id, amount, type, status, payment_method, created_at 
         FROM transactions 
         WHERE user_id = $1 
         ORDER BY created_at DESC 
         LIMIT $2`,
        [userId, limit]
      );
      
      return result.rows;
    } catch (error) {
      console.error('Error fetching transaction history:', error);
      throw error;
    }
  }

  // –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ó–ê–ö–ê–ó–ê–ú–ò

  async savePurchaseWithDetails(purchaseData: {
    user_id: number;
    custom_id: string;
    service_id: number;
    service_name: string;
    quantity: number;
    total_price: number;
    status: 'pending' | 'completed' | 'failed';
    pins?: string[];
    data?: string;
  }): Promise<void> {
    const client = await getClient();
    
    try {
      await client.query('BEGIN');

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—É–ø–∫–µ
      const purchaseResult = await client.query(
        `INSERT INTO purchases (user_id, service_id, service_name, amount, currency, status, purchase_date, custom_id) 
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8) 
         RETURNING *`,
        [
          purchaseData.user_id,
          purchaseData.service_id,
          purchaseData.service_name,
          purchaseData.total_price,
          'USD',
          purchaseData.status,
          new Date().toISOString(),
          purchaseData.custom_id
        ]
      );

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      const paymentDetails = {
        custom_id: purchaseData.custom_id,
        quantity: purchaseData.quantity,
        pins: purchaseData.pins || null,
        data: purchaseData.data || null,
        service_id: purchaseData.service_id,
        service_name: purchaseData.service_name
      };

      await client.query(
        `INSERT INTO transactions (user_id, amount, type, status, payment_method, payment_details) 
         VALUES ($1, $2, 'purchase', $3, 'gifts_api', $4)`,
        [
          purchaseData.user_id,
          purchaseData.total_price,
          purchaseData.status,
          JSON.stringify(paymentDetails)
        ]
      );

      // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å completed, –æ–±–Ω–æ–≤–ª—è–µ–º total_spent
      if (purchaseData.status === 'completed') {
        await client.query(
          `UPDATE users 
           SET total_spent = total_spent + $1,
               updated_at = CURRENT_TIMESTAMP 
           WHERE id = $2`,
          [purchaseData.total_price, purchaseData.user_id]
        );
      }

      await client.query('COMMIT');
    } catch (error) {
      await client.query('ROLLBACK');
      console.error('Error saving purchase with details:', error);
      throw error;
    } finally {
      client.release();
    }
  }

  async updatePurchaseStatus(custom_id: string, status: 'pending' | 'completed' | 'failed', pins?: string[], data?: string): Promise<void> {
    const client = await getClient();
    
    try {
      await client.query('BEGIN');

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∫—É–ø–∫–∏ –ø–æ custom_id
      await client.query(
        `UPDATE purchases 
        SET status = $1 
        WHERE custom_id = $2`,
        [status, custom_id]
      );

      // –ù–∞—Ö–æ–¥–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø–æ custom_id
      const transactionResult = await client.query(
        `SELECT id, user_id, amount 
         FROM transactions 
         WHERE payment_details->>'custom_id' = $1 AND type = 'purchase'`,
        [custom_id]
      );

      if (transactionResult.rows.length === 0) {
        throw new Error(`Transaction not found for custom_id: ${custom_id}`);
      }

      const transaction = transactionResult.rows[0];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∫—É–ø–∫–∏
      await client.query(
        `UPDATE purchases 
         SET status = $1 
         WHERE user_id = $2 AND amount = $3
         ORDER BY created_at DESC 
         LIMIT 1`,
        [status, transaction.user_id, transaction.amount]
      );

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
      await client.query(
        `UPDATE transactions 
         SET status = $1 
         WHERE id = $2`,
        [status, transaction.id]
      );

      // –û–±–Ω–æ–≤–ª—è–µ–º payment_details –µ—Å–ª–∏ –µ—Å—Ç—å pins –∏–ª–∏ data
      if (pins || data) {
        const currentDetailsResult = await client.query(
          `SELECT payment_details FROM transactions WHERE id = $1`,
          [transaction.id]
        );

        const currentDetails = currentDetailsResult.rows[0].payment_details || {};
        const updatedDetails = {
          ...currentDetails,
          ...(pins && { pins }),
          ...(data && { data })
        };

        await client.query(
          `UPDATE transactions 
           SET payment_details = $1 
           WHERE id = $2`,
          [JSON.stringify(updatedDetails), transaction.id]
        );
      }

      // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–ª completed, –æ–±–Ω–æ–≤–ª—è–µ–º total_spent
       if (status === 'completed') {
        const purchaseResult = await client.query(
          `SELECT user_id, amount FROM purchases WHERE custom_id = $1`,
          [custom_id]
        );
        
        if (purchaseResult.rows.length > 0) {
          const purchase = purchaseResult.rows[0];
          await client.query(
            `UPDATE users 
            SET total_spent = total_spent + $1,
                updated_at = CURRENT_TIMESTAMP 
            WHERE id = $2`,
            [purchase.amount, purchase.user_id]
          );
        }
      }

      await client.query('COMMIT');
    } catch (error) {
      await client.query('ROLLBACK');
      console.error('Error updating purchase status:', error);
      throw error;
    } finally {
      client.release();
    }
  }

  async getUserBalance(userId: number): Promise<number> {
    try {
      const result = await query(
        'SELECT balance FROM users WHERE id = $1',
        [userId]
      );
      
      if (result.rows.length === 0) {
        throw new Error('User not found');
      }
      
      return parseFloat(result.rows[0].balance);
    } catch (error) {
      console.error('Error getting user balance:', error);
      throw error;
    }
  }

  async deductUserBalance(userId: number, amount: number): Promise<void> {
    const client = await getClient();
    
    try {
      await client.query('BEGIN');

      const result = await client.query(
        'UPDATE users SET balance = balance - $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2 AND balance >= $1 RETURNING *',
        [amount, userId]
      );

      if (result.rows.length === 0) {
        throw new Error('Insufficient balance or user not found');
      }

      await client.query('COMMIT');
    } catch (error) {
      await client.query('ROLLBACK');
      console.error('Error deducting user balance:', error);
      throw error;
    } finally {
      client.release();
    }
  }


  async getPurchaseByCustomId(custom_id: string): Promise<any> {
    try {
      const result = await query(
        `SELECT p.*, t.payment_details->>'pins' as pins, t.payment_details->>'data' as user_data
        FROM purchases p
        LEFT JOIN transactions t ON t.payment_details->>'custom_id' = p.custom_id
        WHERE p.custom_id = $1`,
        [custom_id]
      );
      
      return result.rows[0] || null;
    } catch (error) {
      console.error('Error fetching purchase by custom_id:', error);
      throw error;
    }
  }
}

export const userService = new UserService();


/backend/src/types/api.types.ts:
export interface Credentials {
  login: string;
  password: string;
}

export interface AuthResponse {
  access_token: string;
  token_type?: string;
  expires_in?: number;
}

export interface Category {
  category_id: number;
  category_name: string;
  category_description?: string;
}

export interface Service {
  service_id: number;
  service_name: string;
  service_description?: string;
  category_id?: number;
}

export interface ApiResponse<T> {
  data?: T;
  status: string;
  message?: string;
}


// Order Types
export interface CreateOrderRequest {
  service_id: number;
  quantity: number;
  custom_id: string;
  data?: string;
}

export interface CreateOrderResponse {
  custom_id: string;
  status: number;
  service_id: number;
  quantity: number;
  total: number;
  date: string;
}

export interface PayOrderRequest {
  custom_id: string;
}

export interface PayOrderResponse {
  message: string;
  custom_id: string;
  status: number;
}

export interface OrderInfo {
  custom_id: string;
  status: number;
  status_message: string;
  product: string;
  quantity: number;
  total_price: number;
  data?: string; // –î–ª—è Steam –∏ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  pins?: string[]; // –î–ª—è gift cards
  [key: string]: any; // –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
}

export interface OrderInfoRequest {
  custom_id: string;
}

// Purchase Types –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
export interface PurchaseRecord {
  id?: number;
  user_id: number;
  custom_id: string;
  service_id: number;
  service_name: string;
  quantity: number;
  total_price: number;
  status: 'pending' | 'completed' | 'failed';
  purchase_date: string;
  created_at?: string;
  updated_at?: string;
  pins?: string[];
  data?: string;
  [key: string]: any; // –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
}

// Cart Types
export interface CartItem {
  service_id: number;
  service_name: string;
  service_description?: string;
  price: number;
  currency: string;
  quantity: number;
  data?: string; // –î–ª—è Steam –ª–æ–≥–∏–Ω–∞ –∏ —Ç.–¥.
}

export interface CheckoutRequest {
  user_id: string;
  items: CartItem[];
}

export interface CheckoutResponse {
  success: boolean;
  custom_id: string;
  service_id: number;
  service_name: string;
  status: number;
  status_message: string;
  pins?: string[];
  data?: string;
  error?: string;
}


/backend/src/types/cardlink.types.ts:
// backend/src/types/cardlink.types.ts
export interface CardLinkCreatePaymentRequest {
  amount: number;
  order_id: string;
  description: string;
  user_id: number;
  success_url?: string;
  fail_url?: string;
}

export interface CardLinkCreatePaymentResponse {
  success: boolean;
  link_url?: string;
  link_page_url?: string;
  bill_id?: string;
  error?: string;
}

export interface CardLinkStatusResponse {
  success: boolean;
  is_paid?: boolean;
  is_failed?: boolean;
  is_processing?: boolean;
  status?: string;
  error?: string;
}

export interface CardLinkWebhookPayload {
  InvId: string;
  OutSum: string;
  Commission: string;
  TrsId: string;
  Status: 'SUCCESS' | 'UNDERPAID' | 'OVERPAID' | 'FAIL';
  CurrencyIn: string;
  custom?: string;
  SignatureValue: string;
}


/backend/src/types/user.types.ts:
export interface User {
  id: number;
  username: string;
  email: string;
  balance: number;
  total_spent: number;
  join_date: string;
  created_at: string;
  updated_at: string;
}

export interface Purchase {
  id: number;
  user_id: number;
  service_id: number;
  service_name: string;
  amount: number;
  currency: string;
  status: 'completed' | 'pending' | 'failed';
  purchase_date: string;
  created_at: string;
}

export interface Transaction {
  id: number;
  user_id: number;
  amount: number;
  type: 'deposit' | 'withdrawal' | 'purchase';
  status: 'pending' | 'completed' | 'failed' | 'cancelled';
  payment_method: string;
  payment_details: any;
  created_at: string;
}

export interface UserProfile {
  user: User;
  purchases: Purchase[];
  totalPurchases: number;
  successfulTransactions: number;
}

export interface BalanceUpdate {
  amount: number;
  payment_method: string;
  payment_details?: any;
}


/backend/src/index.ts:
// backend/src/server.ts
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { requestLogger } from './middleware/logger';
import { giftsRoutes } from './routes/gifts.routes';
import { userRoutes } from './routes/user.routes';
import { cardLinkRoutes } from './routes/cardlink.routes'; // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç

dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;


// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ origin
const corsOptions = {
  origin: function (origin: string | undefined, callback: (err: Error | null, allow?: boolean) => void) {
    // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ origin (–º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, Postman –∏ —Ç.–¥.)
    if (!origin) return callback(null, true);
    
    const allowedOrigins = [
      'https://os-gift.store',
      'https://www.os-gift.store',
      'http://os-gift.store', 
      'http://www.os-gift.store',
      'http://localhost:3000',
      'https://localhost:3000',
      'http://localhost:5173',
      'https://localhost:5173',
      'http://frontend:3000',
      'http://frontend:80',
      'http://backend:5000',
      'http://localhost',
      'http://127.0.0.1:3000',    // ‚Üê –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ
      'https://127.0.0.1:3000',   // ‚Üê –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ
    ];
    
    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      console.log('CORS blocked for origin:', origin);
      callback(new Error('Not allowed by CORS'));
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
  exposedHeaders: ['Content-Length']
};

app.use(cors(corsOptions));


// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
app.use(requestLogger);

app.use(express.json());
app.use(express.urlencoded({ extended: true })); // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è webhook

// Routes
app.get('/api/hello', (req, res) => {
  console.log('‚úÖ GET /api/hello - Handled successfully');
  res.json({ message: 'Hello from Node.js + TypeScript!' });
});

app.get('/api/items', (req, res) => {
  console.log('‚úÖ GET /api/items - Handled successfully');
  res.json({ 
    data: [
      {id: 1, name: 'Steam'},
      {id: 2, name: 'PlayMarket'},
      {id: 3, name: 'Xbox Gift'},
    ] 
  });
});

// –ù–æ–≤—ã–µ —Ä–æ—É—Ç—ã –¥–ª—è Gifts API
app.use('/api/gifts', giftsRoutes);

// –ù–æ–≤—ã–µ —Ä–æ—É—Ç—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
app.use('/api/user', userRoutes);

// –ù–æ–≤—ã–µ —Ä–æ—É—Ç—ã –¥–ª—è CardLink
app.use('/api/cardlink', cardLinkRoutes); // –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ—É—Ç—ã

// Health check
app.get('/api/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

app.listen(PORT, () => {
  console.log(`üöÄ Server is running on http://localhost:${PORT}`);
});


/backend/Dockerfile:
FROM node:18-alpine

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ package-lock.json
COPY package*.json ./
COPY tsconfig.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm install

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY src/ ./src/

# –°–æ–±–∏—Ä–∞–µ–º TypeScript
RUN npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–ª–∏—Å—å
RUN ls -la dist/

EXPOSE 5000

CMD ["node", "dist/index.js"]


/games-stuff-shop/src/api/index.ts:
import axios from 'axios';

// –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API
// const BASE_URL = 'http://localhost:5000/api';
const BASE_URL = '/api';

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä axios —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
export const api = axios.create({
  baseURL: BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
api.interceptors.response.use(
  (response) => response,
  (error) => {
    console.error('API Error:', error.response?.data || error.message);
    return Promise.reject(error);
  }
);


/games-stuff-shop/src/api/user.api.ts:
import { api } from './index';
import type { UserProfile, BalanceUpdateRequest } from '../types/api.types';

export const userApi = {
  // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  getProfile: async (userId: number): Promise<UserProfile> => {
    const response = await api.get(`/user/profile/${userId}`);
    return response.data.data;
  },

  // –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
  updateBalance: async (userId: number, data: BalanceUpdateRequest) => {
    const response = await api.post(`/user/balance/${userId}`, data);
    return response.data.data;
  },

  // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫—É–ø–æ–∫
  getPurchaseHistory: async (userId: number, limit: number = 10) => {
    const response = await api.get(`/user/purchases/${userId}?limit=${limit}`);
    return response.data.data;
  },

  // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  getTransactionHistory: async (userId: number, limit: number = 20) => {
    const response = await api.get(`/user/transactions/${userId}?limit=${limit}`);
    return response.data.data;
  }
};


/games-stuff-shop/src/components/AppRoutes.tsx:
// components/AppRoutes.tsx
import React from 'react';
import { Routes, Route } from 'react-router-dom';
import AllGamesPage from '../pages/AllGames.tsx';
import ProfilePage from '../pages/Profile.tsx';
import ShopCartPage from '../pages/ShopCart.tsx';
import SupportPage from '../pages/Support.tsx';

const AppRoutes: React.FC = () => {
  return (
    <Routes>
      <Route path="/" element={<AllGamesPage />} />
      <Route path="/profile" element={<ProfilePage />} />
      <Route path="/shop-cart" element={<ShopCartPage />} />
      <Route path="/support" element={<SupportPage />} />
    </Routes>
  );
};

export default AppRoutes;


/games-stuff-shop/src/components/CartButtons.tsx:
import React from 'react';
import styled from 'styled-components';
import { useCart } from '../context/CartContext';
import type { ServiceItem } from '../types/api.types';

interface CartButtonProps {
  service: ServiceItem;
}

const CartButton: React.FC<CartButtonProps> = ({ service }) => {
  const { addItem, removeItem, updateQuantity, getItemQuantity } = useCart();
  
  const quantity = getItemQuantity(service.service_id);

  const handleAdd = () => {
    addItem(service);
  };

  const handleRemove = () => {
    if (quantity > 1) {
      updateQuantity(service.service_id, quantity - 1);
    } else {
      removeItem(service.service_id);
    }
  };

  const handleIncrement = () => {
    updateQuantity(service.service_id, quantity + 1);
  };

  if (quantity === 0) {
    return (
      <AddToCartButton onClick={handleAdd}>
        –í –∫–æ—Ä–∑–∏–Ω—É
      </AddToCartButton>
    );
  }

  return (
    <QuantityControl>
      <DecreaseButton onClick={handleRemove}>-</DecreaseButton>
      <QuantityDisplay>{quantity}</QuantityDisplay>
      <IncreaseButton onClick={handleIncrement}>+</IncreaseButton>
    </QuantityControl>
  );
};

export default CartButton;

// Styles
const AddToCartButton = styled.button`
  background: #02A5F8;
  color: white;
  border: none;
  border-radius: 5px;
  padding: 8px 16px;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    background: #0288D1;
    transform: translateY(-2px);
  }

  &:active {
    transform: translateY(0);
  }
`;

const QuantityControl = styled.div`
  display: flex;
  align-items: center;
  background: #F89D09;
  border-radius: 5px;
  overflow: hidden;
  min-width: 100px;
`;

const BaseQuantityButton = styled.button`
  background: none;
  border: none;
  color: white;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.3s ease;

  &:hover {
    background: rgba(255, 255, 255, 0.2);
  }
`;

const DecreaseButton = styled(BaseQuantityButton)`
  border-right: 1px solid rgba(255, 255, 255, 0.3);
`;

const IncreaseButton = styled(BaseQuantityButton)`
  border-left: 1px solid rgba(255, 255, 255, 0.3);
`;

const QuantityDisplay = styled.span`
  color: white;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  padding: 8px 12px;
  flex: 1;
  text-align: center;
  min-width: 30px;
`;


/games-stuff-shop/src/components/HeaderNavigation.tsx:
import styled from "styled-components";
import { useNavigate } from "react-router-dom";
import { useUser } from '../context/UserContext';

// Icons
import Logo from "../assets/icons/Logo.svg";
import BalanceIndicatorIcon from "../assets/icons/rub-icon.svg";
import WalletIcon from "../assets/icons/wallet-icon.svg";
import ProfileIcon from "../assets/icons/menu-profile-icon.svg"

const HeaderNavigation: React.FC = () => {
    const navigate = useNavigate();
    const { user, loading } = useUser();

    const handleTopUpClick = () => {
        navigate('/profile?topup=true');
    };

    const handleProfileClick = () => {
        navigate('/profile');
    };

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const formatBalance = (balance: number) => {
        return balance.toLocaleString('ru-RU');
    };

    return (
        <NavLine>
            <StyledLogo src={Logo} />
            <BalanceIndicator>
                <img src={BalanceIndicatorIcon} alt="BalanceIndicator" />
                <span>
                    {loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : user ? formatBalance(user.balance) : '0'}
                </span>
            </BalanceIndicator>
            <TopUpButton onClick={handleTopUpClick}>
                <img src={WalletIcon} alt="WalletIcon" />
            </TopUpButton>
            <ProfileButton onClick={handleProfileClick}>
                <img src={ProfileIcon} alt="ProfileIcon" />
            </ProfileButton>
        </NavLine>
    )
}

export default HeaderNavigation;

// Styles (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
const StyledLogo = styled.img`
    height: 100%;
    user-select: none;
    -webkit-user-drag: none;
`;

const NavLine = styled.div`
    display: flex;
    flex-direction: row;

    box-sizing; border-box;
    padding: 12px 16px;

    border: 1px solid rgba(255, 255, 255, 10%);
    max-width: var(--max-window-width);

    position: fixed;
    width: calc(100% - 24px);

    border-radius: 14px;

    align-items: center;
    gap: 5px;

    min-height: 70px;
    max-height: 80px;
    height: 100%;
    box-sizing: border-box;

    min-width: 320px;

    background: rgba(21, 25, 50, 0.8);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);

    z-index: 999;
`

const BalanceIndicator = styled.div`
    display: flex;
    flex-direction: row;

    border-radius: 7px;
    border: 0.5px solid #707070;

    align-items: center;
    justify-content: space-around;
    max-width: 180px;
    min-width: auto;
    box-sizing: border-box;
    padding: 5px;

    margin-left: auto;
    margin-right: 0;
    gap: 10px;

    height: 85%;

    & img {
        max-width: 28px;
        min-width: 28px;
        aspect-ration: 1;
    }

    & span {
        color: #fff;
        font-family: "Jura-Regular";
        font-size: 20px;
    }
`;

const TopUpButton = styled.button`
    border-radius: 7px;
    padding: 10px;
    aspect-ratio: 1;

    background: linear-gradient(to right, #88FB47, #27C151);
    border: none;

    height: 85%;
    display: flex;
    align-items: center;
    justify-content: center;

    & img {
        width: 24px;
        height: auto;
    }

    &:hover {
        cursor: pointer;
    }
`;

const ProfileButton = styled.button`
    border-radius: 7px;
    padding: 10px;
    aspect-ratio: 1;

    background: none;
    border: 0.5px solid #707070;

    height: 85%;
    display: flex;
    align-items: center;
    justify-content: center;

    & img {
        width: 24px;
        height: auto;
    }

    &:hover {
        cursor: pointer;
    }
`;


/games-stuff-shop/src/components/Navigation.tsx:
// components/Navigation.tsx
import React from 'react';
import { NavLink } from 'react-router-dom';
import { useCart } from '../context/CartContext';
import styled from 'styled-components';

// Icons
import AllGamesIcon from "../assets/icons/menu-games-icon.svg";
import ProfileIcon from "../assets/icons/menu-profile-icon.svg";
import ShopCartIcon from "../assets/icons/menu-shop-cart-icon.svg";
import SupportIcon from "../assets/icons/menu-support-icon.svg";

import ActiveAllGamesIcon from "../assets/icons/menu-active-games-icon.svg"; // —Ä–∞–∑–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
import ActiveProfileIcon from "../assets/icons/menu-active-profile-icon.svg";
import ActiveShopCartIcon from "../assets/icons/menu-active-shop-cart-icon.svg";
import ActiveSupportIcon from "../assets/icons/menu-active-support-icon.svg";

const Navigation: React.FC = () => {
  const { state } = useCart();
  const totalItems = state.items.reduce((total, item) => total + item.quantity, 0);
  
  return (
    <NavigationPanel>
      <NavButton to="/">
        {({ isActive }) => (
          <>
            <img 
              src={isActive ? ActiveAllGamesIcon : AllGamesIcon} 
              alt="GamesLogo" 
            />
            <span>Games</span>
          </>
        )}
      </NavButton>
      
      <NavButton to="/profile">
        {({ isActive }) => (
          <>
            <img 
              src={isActive ? ActiveProfileIcon : ProfileIcon} 
              alt="ProfileLogo" 
            />
            <span>Profile</span>
          </>
        )}
      </NavButton>
      
      <NavButton to="/shop-cart">
        {({ isActive }) => (
          <>
            <CartIconContainer>
              <img 
                src={isActive ? ActiveShopCartIcon : ShopCartIcon} 
                alt="ShopCartLogo" 
              />
              {totalItems > 0 && (
                <CartBadge>{totalItems}</CartBadge>
              )}
            </CartIconContainer>
            <span>Shop Cart</span>
          </>
        )}
      </NavButton>
      
      <NavButton to="/support">
        {({ isActive }) => (
          <>
            <img 
              src={isActive ? ActiveSupportIcon : SupportIcon} 
              alt="SupportLogo" 
            />
            <span>Support</span>
          </>
        )}
      </NavButton>
    </NavigationPanel>
  );
};

export default Navigation;

// Styles
const NavigationPanel = styled.nav`
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  z-index: 999;

  @media (min-width: 1200px) {
    left: calc((100% - var(--max-window-width)) / 2);
  }

  margin-top: auto;
  margin-bottom: 0;
  min-height: 90px;
  max-height: 90px;
  height: 100%;

  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-evenly;
  box-sizing: border-box;

  background: rgba(21, 25, 50, 0.8);
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  border-top: 1px solid rgba(255, 255, 255, 0.1);

  max-width: var(--max-window-width);
`;

const NavButton = styled(NavLink)`
  text-decoration: none;
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 8px;
  padding: 0 16px;
  transition: all 0.3s ease;
  position: relative;

  &:hover {
    color: #fff;
  }

  &:hover img {
    filter: brightness(0) saturate(100%) invert(68%) sepia(90%) saturate(500%) hue-rotate(360deg) brightness(100%) contrast(105%);
  }

  /* –ê–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
  &.active {
    color: #FFF;

    &::after {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 3px;
      background: #F89D09;
      border-radius: 2px;
    }
  }

  &.active img {
    filter: brightness(0) saturate(100%) invert(68%) sepia(90%) saturate(500%) hue-rotate(360deg) brightness(100%) contrast(105%);
  }
`;

const CartIconContainer = styled.div`
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
`;

const CartBadge = styled.span`
  position: absolute;
  top: -8px;
  right: -8px;
  background: #F89D09;
  color: white;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  font-size: 10px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "ChakraPetch-Regular";
`;


/games-stuff-shop/src/context/CartContext.tsx:
import React, { createContext, useContext, useReducer } from 'react';
import type { ReactNode } from 'react';
import type { ServiceItem } from '../types/api.types';

export interface CartItem extends ServiceItem {
  quantity: number;
  userData?: string; // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Steam –ª–æ–≥–∏–Ω –∏ —Ç.–¥.)
}

interface CartState {
  items: CartItem[];
  total: number;
}

type CartAction = 
  | { type: 'ADD_ITEM'; payload: ServiceItem }
  | { type: 'REMOVE_ITEM'; payload: number }
  | { type: 'UPDATE_QUANTITY'; payload: { serviceId: number; quantity: number } }
  | { type: 'UPDATE_USER_DATA'; payload: { serviceId: number; userData: string } }
  | { type: 'CLEAR_CART' }
  | { type: 'SET_ITEMS'; payload: CartItem[] };

interface CartContextType {
  state: CartState;
  addItem: (item: ServiceItem) => void;
  removeItem: (serviceId: number) => void;
  updateQuantity: (serviceId: number, quantity: number) => void;
  updateUserData: (serviceId: number, userData: string) => void;
  clearCart: () => void;
  setItems: (items: CartItem[]) => void;
  getItemQuantity: (serviceId: number) => number;
  getUserData: (serviceId: number) => string | undefined;
  getItemCount: () => number;
  requiresUserData: (serviceName: string) => boolean;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

// –†–µ–¥—É–∫—Ç–æ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–æ—Ä–∑–∏–Ω—ã
const cartReducer = (state: CartState, action: CartAction): CartState => {
  switch (action.type) {
    case 'ADD_ITEM': {
      const existingItem = state.items.find(item => item.service_id === action.payload.service_id);
      
      if (existingItem) {
        // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–∂–µ –µ—Å—Ç—å, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        const updatedItems = state.items.map(item =>
          item.service_id === action.payload.service_id
            ? { ...item, quantity: item.quantity + 1 }
            : item
        );
        
        return {
          ...state,
          items: updatedItems,
          total: calculateTotal(updatedItems)
        };
      } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
        const newItem: CartItem = { 
          ...action.payload, 
          quantity: 1,
          userData: requiresUserData(action.payload.service_name) ? '' : undefined
        };
        const updatedItems = [...state.items, newItem];
        
        return {
          ...state,
          items: updatedItems,
          total: calculateTotal(updatedItems)
        };
      }
    }
    
    case 'REMOVE_ITEM': {
      const updatedItems = state.items.filter(item => item.service_id !== action.payload);
      
      return {
        ...state,
        items: updatedItems,
        total: calculateTotal(updatedItems)
      };
    }
    
    case 'UPDATE_QUANTITY': {
      const { serviceId, quantity } = action.payload;
      
      if (quantity <= 0) {
        // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 0 –∏–ª–∏ –º–µ–Ω—å—à–µ, —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä
        return cartReducer(state, { type: 'REMOVE_ITEM', payload: serviceId });
      }
      
      const updatedItems = state.items.map(item =>
        item.service_id === serviceId
          ? { ...item, quantity }
          : item
      );
      
      return {
        ...state,
        items: updatedItems,
        total: calculateTotal(updatedItems)
      };
    }
    
    case 'UPDATE_USER_DATA': {
      const { serviceId, userData } = action.payload;
      const updatedItems = state.items.map(item =>
        item.service_id === serviceId
          ? { ...item, userData }
          : item
      );
      
      return {
        ...state,
        items: updatedItems
      };
    }
    
    case 'SET_ITEMS': {
      return {
        items: action.payload,
        total: calculateTotal(action.payload)
      };
    }
    
    case 'CLEAR_CART':
      return {
        items: [],
        total: 0
      };
    
    default:
      return state;
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—É–º–º—ã
const calculateTotal = (items: CartItem[]): number => {
  return items.reduce((total, item) => {
    const price = item.price || 0;
    return total + (price * item.quantity);
  }, 0);
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const requiresUserData = (serviceName: string): boolean => {
  const lowerName = serviceName.toLowerCase();
  return lowerName.includes('steam') || 
         lowerName.includes('account') || 
         lowerName.includes('login') ||
         lowerName.includes('–∞–∫–∫–∞—É–Ω—Ç') ||
         lowerName.includes('–ª–æ–≥–∏–Ω');
};

// –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
export const CartProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(cartReducer, {
    items: [],
    total: 0
  });

  const addItem = (item: ServiceItem) => {
    dispatch({ type: 'ADD_ITEM', payload: item });
  };

  const removeItem = (serviceId: number) => {
    dispatch({ type: 'REMOVE_ITEM', payload: serviceId });
  };

  const updateQuantity = (serviceId: number, quantity: number) => {
    dispatch({ type: 'UPDATE_QUANTITY', payload: { serviceId, quantity } });
  };

  const updateUserData = (serviceId: number, userData: string) => {
    dispatch({ type: 'UPDATE_USER_DATA', payload: { serviceId, userData } });
  };

  const clearCart = () => {
    dispatch({ type: 'CLEAR_CART' });
  };

  const setItems = (items: CartItem[]) => {
    dispatch({ type: 'SET_ITEMS', payload: items });
  };

  const getItemQuantity = (serviceId: number): number => {
    const item = state.items.find(item => item.service_id === serviceId);
    return item ? item.quantity : 0;
  };

  const getUserData = (serviceId: number): string | undefined => {
    const item = state.items.find(item => item.service_id === serviceId);
    return item?.userData;
  };

  const getItemCount = (): number => {
    return state.items.reduce((total, item) => total + item.quantity, 0);
  };

  return (
    <CartContext.Provider value={{
      state,
      addItem,
      removeItem,
      updateQuantity,
      updateUserData,
      clearCart,
      setItems,
      getItemQuantity,
      getUserData,
      getItemCount,
      requiresUserData
    }}>
      {children}
    </CartContext.Provider>
  );
};

// –•—É–∫ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
export const useCart = () => {
  const context = useContext(CartContext);
  if (context === undefined) {
    throw new Error('useCart must be used within a CartProvider');
  }
  return context;
};


/games-stuff-shop/src/context/UserContext.tsx:
import React, { createContext, useContext, useState, useEffect } from 'react';
import type { ReactNode } from 'react';
import { userApi } from '../api/user.api';
import type { User, UserProfile } from '../types/api.types';

interface UserContextType {
  user: User | null;
  profile: UserProfile | null;
  loading: boolean;
  error: string | null;
  refreshUser: () => Promise<void>;
  updateBalance: (newBalance: number) => void;
}

const UserContext = createContext<UserContextType | undefined>(undefined);

export const UserProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  const loadUserData = async () => {
    try {
      setLoading(true);
      setError(null);
      
      // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID 1, –ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ auth
      const userId = 1;
      const profileData = await userApi.getProfile(userId);
      
      setProfile(profileData);
      setUser(profileData.user);
    } catch (err) {
      console.error('Error loading user data:', err);
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    } finally {
      setLoading(false);
    }
  };

  const refreshUser = async () => {
    await loadUserData();
  };

  const updateBalance = (newBalance: number) => {
    if (user) {
      setUser(prev => prev ? { ...prev, balance: newBalance } : null);
    }
    
    if (profile) {
      setProfile(prev => prev ? { 
        ...prev, 
        user: { ...prev.user, balance: newBalance } 
      } : null);
    }
  };

  useEffect(() => {
    loadUserData();
  }, []);

  return (
    <UserContext.Provider value={{
      user,
      profile,
      loading,
      error,
      refreshUser,
      updateBalance
    }}>
      {children}
    </UserContext.Provider>
  );
};

export const useUser = () => {
  const context = useContext(UserContext);
  if (context === undefined) {
    throw new Error('useUser must be used within a UserProvider');
  }
  return context;
};


/games-stuff-shop/src/hooks/useCurrency.ts:
import { useState, useEffect, useCallback } from 'react';
import { currencyService } from '../services/currencyService';

interface UseCurrencyReturn {
  convertToRub: (amount: number, fromCurrency: string) => Promise<number>;
  formatRubles: (amount: number) => string;
  usdToRubRate: number | null;
  loading: boolean;
  error: string | null;
  refreshRates: () => Promise<void>;
}

export const useCurrency = (): UseCurrencyReturn => {
  const [usdToRubRate, setUsdToRubRate] = useState<number | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  const loadExchangeRate = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const rate = await currencyService.getUsdToRubRate();
      setUsdToRubRate(rate);
    } catch (err) {
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å –≤–∞–ª—é—Ç');
      console.error('Error loading exchange rate:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadExchangeRate();
  }, [loadExchangeRate]);

  const convertToRub = useCallback(async (amount: number, fromCurrency: string): Promise<number> => {
    return await currencyService.convertToRub(amount, fromCurrency);
  }, []);

  const formatRubles = useCallback((amount: number): string => {
    return currencyService.formatRubles(amount);
  }, []);

  const refreshRates = useCallback(async (): Promise<void> => {
    await loadExchangeRate();
  }, [loadExchangeRate]);

  return {
    convertToRub,
    formatRubles,
    usdToRubRate,
    loading,
    error,
    refreshRates
  };
};


/games-stuff-shop/src/hooks/useOrders.ts:
import { useState, useCallback, useMemo } from 'react';
import { orderService, type CheckoutResponse, type CheckoutItemResult } from '../services/orderService';
import { type CartItem } from '../context/CartContext';

export interface OrderState {
  loading: boolean;
  error: string | null;
  result: CheckoutResponse | null;
}

export interface UseOrdersReturn extends OrderState {
  checkout: (userId: number, items: CartItem[]) => Promise<CheckoutResponse>;
  reset: () => void;
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  successCount: number;
  failedCount: number;
  totalAmount: number;
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
  successItems: CheckoutItemResult[];
  failedItems: CheckoutItemResult[];
  pendingItems: CheckoutItemResult[];
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  validateCheckout: (items: CartItem[]) => string | null;
  // –£—Ç–∏–ª–∏—Ç—ã
  getStatusText: (status: number) => string;
  getStatusColor: (status: number) => string;
  requiresUserData: (serviceName: string) => boolean;
}

export const useOrders = (): UseOrdersReturn => {
  const [state, setState] = useState<OrderState>({
    loading: false,
    error: null,
    result: null,
  });

  const checkout = useCallback(async (userId: number, items: CartItem[]): Promise<CheckoutResponse> => {
    setState({ loading: true, error: null, result: null });
    
    try {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
      const validationError = orderService.validateCartForCheckout(items);
      if (validationError) {
        throw new Error(validationError);
      }

      const result = await orderService.checkout({ 
        user_id: userId, 
        items 
      });
      
      setState({ loading: false, error: null, result });
      return result;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';
      setState({ loading: false, error: errorMessage, result: null });
      throw error;
    }
  }, []);

  const reset = useCallback(() => {
    setState({ loading: false, error: null, result: null });
  }, []);

  // –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const successCount = useMemo(() => 
    state.result?.data.total_processed || 0, 
    [state.result]
  );

  const failedCount = useMemo(() => 
    state.result?.data.total_failed || 0, 
    [state.result]
  );

  const totalAmount = useMemo(() => 
    state.result?.data.total_amount || 0, 
    [state.result]
  );

  const successItems = useMemo(() => 
    state.result?.data.results.filter(item => item.success) || [], 
    [state.result]
  );

  const failedItems = useMemo(() => 
    state.result?.data.results.filter(item => !item.success) || [], 
    [state.result]
  );

  const pendingItems = useMemo(() => 
    state.result?.data.results.filter(item => item.status === 1) || [], 
    [state.result]
  );

  const validateCheckout = useCallback((items: CartItem[]): string | null => {
    return orderService.validateCartForCheckout(items);
  }, []);

  const getStatusText = useCallback((status: number): string => {
    return orderService.getOrderStatusText(status);
  }, []);

  const getStatusColor = useCallback((status: number): string => {
    return orderService.getOrderStatusColor(status);
  }, []);

  const requiresUserData = useCallback((serviceName: string): boolean => {
    return orderService.requiresUserData(serviceName);
  }, []);

  return {
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ
    ...state,
    // –ú–µ—Ç–æ–¥—ã
    checkout,
    reset,
    validateCheckout,
    getStatusText,
    getStatusColor,
    requiresUserData,
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    successCount,
    failedCount,
    totalAmount,
    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    successItems,
    failedItems,
    pendingItems,
  };
};


/games-stuff-shop/src/pages/AllGames.tsx:
import styled, { keyframes } from "styled-components";
import { api } from "../api";
import { useEffect, useState } from "react";
// Types
import type {  
  GiftsCategories, 
  CategoryWithImage, 
  ServiceItem,
  ServicesResponse 
} from "../types/api.types";
import { groupCategories } from "../utils/categoryUtils";
import { CountryFlag } from "../utils/countryFlags";
import AdvImage from "../assets/images/vpn-add.png";

import CartButton from '../components/CartButton';
import { useCurrency } from '../hooks/useCurrency'; // –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç

const AllGamesPage: React.FC = () => {
    const [categories, setCategories] = useState<CategoryWithImage[]>([]);
    const [selectedCategory, setSelectedCategory] = useState<CategoryWithImage | null>(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [services, setServices] = useState<ServiceItem[]>([]);
    const [isServicesModalOpen, setIsServicesModalOpen] = useState(false);
    const [loading, setLoading] = useState(false);
    const [categoriesLoading, setCategoriesLoading] = useState(true);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ö—É–∫ –¥–ª—è –≤–∞–ª—é—Ç—ã
    const { convertToRub, formatRubles, loading: ratesLoading } = useCurrency();
    const [convertedPrices, setConvertedPrices] = useState<{ [key: string]: number }>({});

    useEffect(() => {
        const fetchCategories = async () => {
            try {
                setCategoriesLoading(true);
                const response = await api.get<GiftsCategories>('/gifts/categories');
                const groupedCategories = groupCategories(response.data.data);
                setCategories(groupedCategories);
            } catch (error) {
                console.error('Error fetching categories:', error);
            } finally {
                setCategoriesLoading(false);
            }
        }

        fetchCategories();
    }, []);

    // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ü–µ–Ω —Å–µ—Ä–≤–∏—Å–æ–≤
    useEffect(() => {
        const convertServicePrices = async () => {
            if (!services.length || ratesLoading) return;

            const converted: { [key: string]: number } = {};
            
            for (const service of services) {
                if (service.price) {
                    try {
                        const rubPrice = await convertToRub(service.price, service.currency || 'USD');
                        converted[service.service_id] = rubPrice;
                    } catch (err) {
                        console.error(`Error converting price for service ${service.service_id}:`, err);
                        // Fallback –Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å
                        converted[service.service_id] = service.price * 90;
                    }
                }
            }
            
            setConvertedPrices(converted);
        };

        convertServicePrices();
    }, [services, convertToRub, ratesLoading]);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ü–µ–Ω—ã
    const renderPrice = (service: ServiceItem) => {
        if (!service.price) return null;

        const rubPrice = convertedPrices[service.service_id];
        
        if (rubPrice) {
            return (
                <ServicePrice>
                    <RubPrice>{formatRubles(rubPrice)}</RubPrice>
                    <OriginalPrice>
                        {service.price} {service.currency || 'USD'}
                    </OriginalPrice>
                </ServicePrice>
            );
        } else {
            return (
                <ServicePrice>
                    <OriginalPrice>
                        {service.price} {service.currency || 'USD'}
                    </OriginalPrice>
                    {ratesLoading && <PriceLoading>...</PriceLoading>}
                </ServicePrice>
            );
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
    const disableScroll = () => {
        const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = `${scrollBarWidth}px`;
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
    const enableScroll = () => {
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    };

    // –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–æ–º –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    useEffect(() => {
        if (isModalOpen || isServicesModalOpen) {
            disableScroll();
        } else {
            enableScroll();
        }

        // Cleanup function - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        return () => {
            enableScroll();
        };
    }, [isModalOpen, isServicesModalOpen]);

    const handleCategoryClick = (category: CategoryWithImage) => {
        setSelectedCategory(category);
        setIsModalOpen(true);
    };

    const handleCountrySelect = async (tag: string, tagID: number) => {
        console.log(`Selected country: ${tag} with ID: ${tagID}`);
        
        try {
            setLoading(true);
            setConvertedPrices({}); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã –ø–æ category_id (tagID)
            const response = await api.get<ServicesResponse>('/gifts/services/by-category', {
                params: { category_id: tagID }
            });
            
            setServices(response.data.data.sort((el1, el2) => el1.service_id - el2.service_id).filter((item) => item.in_stock !== 0));
            setIsServicesModalOpen(true);
        } catch (error) {
            console.error('Error fetching services:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–µ—Ä–≤–∏—Å–æ–≤');
        } finally {
            setLoading(false);
            setIsModalOpen(false);
            setSelectedCategory(null);
        }
    };

    const closeModal = () => {
        setIsModalOpen(false);
        setSelectedCategory(null);
    };

    const closeServicesModal = () => {
        setIsServicesModalOpen(false);
        setServices([]);
        setConvertedPrices({}); // –û—á–∏—â–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    };

    return (
        <>
            {categoriesLoading ? (
                <LoadingContainer>
                    <Spinner />
                    <LoadingText>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</LoadingText>
                </LoadingContainer>
            ) : (
                <div>
                    <AdvBlock onClick={() => window.open('https://t.me/VPNos_bot', '_blank')}>
                        <img src={AdvImage} alt="AdvImage" />
                        <InfoAdvBlock>
                            <AdvTitle>osVPN | –ë—ã—Å—Ç—Ä—ã–π –∏ –ù–∞–¥–µ–∂–Ω—ã–π VPN</AdvTitle>
                            <AdvAbout>üõ° –°–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π VPN-—Å–µ—Ä–≤–∏—Å –ø—Ä—è–º–æ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ!</AdvAbout>
                        </InfoAdvBlock>
                    </AdvBlock>
                    <CategoriesGrid>
                        {categories.map((category) => (
                            <CategoryCard 
                                key={category.id} 
                                onClick={() => handleCategoryClick(category)}
                            >
                                <CategoryImage 
                                    src={`/assets/images/Gifts/${category.image}.png`} 
                                    alt={category.name}
                                    onError={(e) => {
                                        e.currentTarget.src = '/assets/images/Gifts/games_pc_mac.png';
                                    }}
                                />
                                <CategoryInfo>
                                    <CategoryName>{category.name}</CategoryName>
                                </CategoryInfo>
                            </CategoryCard>
                        ))}
                    </CategoriesGrid>
                </div>
            )}

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞–Ω—ã */}
            {isModalOpen && selectedCategory && (
                <ModalOverlay onClick={closeModal}>
                    <ModalContent onClick={(e) => e.stopPropagation()}>
                        <ModalHeader>
                            <ModalTitle>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω - {selectedCategory.name}</ModalTitle>
                            <CloseButton onClick={closeModal}>√ó</CloseButton>
                        </ModalHeader>
                        
                        <ModalBody>
                            <CountriesList>
                                {selectedCategory.tags.map((tag, index) => (
                                    <CountryItem 
                                        key={selectedCategory.tagIDs[index]}
                                        onClick={() => handleCountrySelect(tag, selectedCategory.tagIDs[index])}
                                    >
                                        <CountryFlagContainer>
                                            <CountryFlag countryCode={tag} size={20} />
                                        </CountryFlagContainer>
                                        <CountryName>{tag}</CountryName>
                                        <CountryArrow>‚Üí</CountryArrow>
                                    </CountryItem>
                                ))}
                                
                                {selectedCategory.tags.length === 0 && (
                                    <EmptyMessage>
                                        –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
                                    </EmptyMessage>
                                )}
                            </CountriesList>
                        </ModalBody>
                    </ModalContent>
                </ModalOverlay>
            )}

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞ */}
            {isServicesModalOpen && (
                <ModalOverlay onClick={closeServicesModal}>
                    <ModalContent onClick={(e) => e.stopPropagation()}>
                        <ModalHeader>
                            <ModalTitle>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã</ModalTitle>
                            <CloseButton onClick={closeServicesModal}>√ó</CloseButton>
                        </ModalHeader>
                        
                        <ModalBody>
                            {loading ? (
                                <LoadingContainer>
                                    <Spinner />
                                    <LoadingText>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...</LoadingText>
                                </LoadingContainer>
                            ) : services.length > 0 ? (
                                <ServicesList>
                                    {services.map((service) => (
                                        <ServiceItem key={service.service_id}>
                                            <ServiceInfo>
                                                <ServiceName>{service.service_name}</ServiceName>
                                                {service.service_description && (
                                                    <ServiceDescription>
                                                        {service.service_description}
                                                    </ServiceDescription>
                                                )}
                                                {renderPrice(service)}
                                            </ServiceInfo>
                                            <CartButton service={service} />
                                        </ServiceItem>
                                    ))}
                                </ServicesList>
                            ) : (
                                <EmptyMessage>
                                    –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
                                </EmptyMessage>
                            )}
                        </ModalBody>
                    </ModalContent>
                </ModalOverlay>
            )}
        </>
    )
}

export default AllGamesPage;

// –ê–Ω–∏–º–∞—Ü–∏–∏
const spin = keyframes`
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
`;

// const pulse = keyframes`
//   0% { opacity: 1; }
//   50% { opacity: 0.5; }
//   100% { opacity: 1; }
// `;

// const shimmer = keyframes`
//   0% { background-position: -200px 0; }
//   100% { background-position: 200px 0; }
// `;

// –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
const LoadingContainer = styled.div`
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    gap: 20px;
`;

const Spinner = styled.div`
    width: 50px;
    height: 50px;
    border: 4px solid rgba(136, 251, 71, 0.3);
    border-top: 4px solid #88FB47;
    border-radius: 50%;
    animation: ${spin} 1s linear infinite;
`;

const LoadingText = styled.span`
    color: #88FB47;
    font-size: 16px;
    font-family: "ChakraPetch-Regular";
    text-align: center;
`;

// const SkeletonLoader = styled.div`
//     background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
//     background-size: 200px 100%;
//     animation: ${shimmer} 1.5s infinite;
//     border-radius: 8px;
// `;

// // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å–∫–µ–ª–µ—Ç–æ–Ω–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
// const CategorySkeleton = styled(SkeletonLoader)`
//     width: 190px;
//     height: 190px;
//     border-radius: 12px;
// `;

// // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø—É–ª—å—Å–∏—Ä—É—é—â–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
// const PulseLoader = styled.div`
//     animation: ${pulse} 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
// `;

const fadeIn = keyframes`
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
`;

// Styles

// const ServiceArrow = styled.span`
//     color: #88FB47;
//     font-size: 18px;
//     font-weight: bold;
//     margin-left: 12px;
// `;

const ServicePrice = styled.div`
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-top: 4px;
`;

const RubPrice = styled.span`
    color: #88FB47;
    font-size: 14px;
    font-weight: 600;
    font-family: "ChakraPetch-Regular";
`;

const OriginalPrice = styled.span`
    color: #737591;
    font-size: 12px;
    font-family: "ChakraPetch-Regular";
`;

const PriceLoading = styled.span`
    color: #737591;
    font-size: 12px;
    font-family: "ChakraPetch-Regular";
    font-style: italic;
`;

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
const AdvBlock = styled.div`
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    border: 0.5px solid #C0C0C0;
    border-radius: 14px;
    box-sizing: border-box;
    padding: 3px;
    margin-bottom: 24px;
    cursor: pointer;

    min-width: 320px;
    max-width: 500px;

    margin-left: auto;
    margin-right: auto;
`
const InfoAdvBlock = styled.div`
    display: flex;
    flex-direction: column;
    gap: 5px;
    justify-content: center;
`;
const AdvTitle = styled.span`
    font-family: "Jura-Regular";
    font-size: 14px;
    color: #fff;
    font-weight: 700;
`;
const AdvAbout = styled.span`
    font-family: "Jura-Regular";
    font-size: 12px;
    color: #fff;
`;

const CategoriesGrid = styled.div`
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    max-width: var(--max-window-width);
    margin: 0 auto;
    justify-content: center;
    margin-left: auto;
    margin-right: auto;
    animation: ${fadeIn} 0.5s ease-out;
`;

const CategoryCard = styled.div`
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    flex: 1 0 45%;
    box-sizing: border-box;

    overflow: hidden;
    max-height: 190px;
    max-width: 190px;
    aspect-ratio: 1;

    &:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    position: relative;
`;

const CategoryImage = styled.img`
    width: 100%;
    height: 100%;
    border-radius: 8px;
    object-fit: cover;
`;

const CategoryInfo = styled.div`
    display: flex;
    flex-direction: column;
    gap: 5px;

    position: absolute;
    top: 8px;
    left: 6px;
`;

const CategoryName = styled.span`
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    font-family: "ChakraPetch-Regular";

    padding: 4px 12px;
    backdrop-filter: blur(24px);
    border-radius: 100px;
    background: rgba(0, 0, 0, 25%);

    max-width: 150px;
    box-sizing: border-box;
`;

// –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
const ModalOverlay = styled.div`
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
`;

const ModalContent = styled.div`
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 20px;
    padding: 0;
    max-width: 400px;
    width: 100%;
    max-height: 80vh;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
`;

const ModalHeader = styled.div`
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
`;

const ModalTitle = styled.h2`
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    font-family: "ChakraPetch-Regular";
    margin: 0;
`;

const CloseButton = styled.button`
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.3s ease;

    &:hover {
        background: rgba(255, 255, 255, 0.1);
    }
`;

const ModalBody = styled.div`
    padding: 0;
    max-height: 60vh;
    overflow-y: auto;
`;

const CountriesList = styled.div`
    display: flex;
    flex-direction: column;
`;

const CountryItem = styled.div`
    display: flex;
    align-items: center;
    padding: 16px 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);

    &:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    &:last-child {
        border-bottom: none;
    }
`;

const CountryFlagContainer = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  width: 24px;
  height: 18px;
`;

const CountryName = styled.span`
    color: #fff;
    font-size: 16px;
    font-family: "ChakraPetch-Regular";
    flex: 1;
`;

const CountryArrow = styled.span`
    color: #88FB47;
    font-size: 18px;
    font-weight: bold;
`;

const EmptyMessage = styled.div`
    color: #737591;
    text-align: center;
    padding: 40px 24px;
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
`;

const ServicesList = styled.div`
    display: flex;
    flex-direction: column;
`;

const ServiceItem = styled.div`
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);

    &:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    &:last-child {
        border-bottom: none;
    }
`;

const ServiceInfo = styled.div`
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
`;

const ServiceName = styled.span`
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    font-family: "ChakraPetch-Regular";
`;

const ServiceDescription = styled.span`
    color: #737591;
    font-size: 14px;
    font-family: "ChakraPetch-Regular";
`;


/games-stuff-shop/src/pages/Profile.tsx:
import React, { useState, useEffect } from 'react';
import { useSearchParams } from 'react-router-dom';
import styled, { keyframes } from 'styled-components';
import { userApi } from '../api/user.api';
import { useUser } from '../context/UserContext';
import { cardLinkService } from '../services/cardlink.service';
import { orderService } from '../services/orderService';
import { useCurrency } from '../hooks/useCurrency';

const ProfilePage: React.FC = () => {
  const { user, profile, loading, error, refreshUser, updateBalance } = useUser();
  const { convertToRub, formatRubles, usdToRubRate, loading: ratesLoading } = useCurrency();
  
  const [addAmount, setAddAmount] = useState<string>('');
  const [updatingBalance, setUpdatingBalance] = useState<boolean>(false);
  const [selectedPayment, setSelectedPayment] = useState<string>('cardlink');

  const [searchParams, setSearchParams] = useSearchParams();
  const [isAddingBalance, setIsAddingBalance] = useState<boolean>(false);

  const [processingCardLink, setProcessingCardLink] = useState<boolean>(false);
  const [paymentStatus, setPaymentStatus] = useState<string>('');

  const [copyStatus, setCopyStatus] = useState<{ [key: string]: boolean }>({});
  const [loadingOrder, setLoadingOrder] = useState<{ [key: string]: boolean }>({});

  const [convertedAmounts, setConvertedAmounts] = useState<{ [key: string]: number }>({});
  const [convertedTotalSpent, setConvertedTotalSpent] = useState<number | null>(null);

  useEffect(() => {
    const shouldOpenTopUp = searchParams.get('topup') === 'true';
    const paymentStatus = searchParams.get('payment');
    
    if (shouldOpenTopUp) {
      const timer = setTimeout(() => {
        setIsAddingBalance(true);
        searchParams.delete('topup');
        setSearchParams(searchParams);
      }, 500);
      
      return () => clearTimeout(timer);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
    if (paymentStatus === 'success') {
      alert('–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!');
      searchParams.delete('payment');
      setSearchParams(searchParams);
      refreshUser(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    } else if (paymentStatus === 'failed') {
      alert('–ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
      searchParams.delete('payment');
      setSearchParams(searchParams);
    }
  }, [searchParams, setSearchParams, refreshUser]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫
  useEffect(() => {
    const convertPurchases = async () => {
      if (!profile?.purchases || ratesLoading) return;

      const converted: { [key: string]: number } = {};
      
      for (const purchase of profile.purchases) {
        try {
          const rubAmount = await convertToRub(purchase.amount, purchase.currency);
          converted[purchase.id] = rubAmount;
        } catch (err) {
          console.error(`Error converting purchase ${purchase.id}:`, err);
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å
          converted[purchase.id] = purchase.amount * (usdToRubRate || 90);
        }
      }
      
      setConvertedAmounts(converted);
    };

    convertPurchases();
  }, [profile?.purchases, convertToRub, ratesLoading, usdToRubRate]);

  // –î–æ–±–∞–≤–∏–º useEffect –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ total_spent
  useEffect(() => {
    const convertTotalSpent = async () => {
      if (!user?.total_spent || ratesLoading) return;

      try {
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ total_spent –≤ USD (–∫–∞–∫ –≤ –≤–∞—à–µ–π –ë–î)
        const rubAmount = await convertToRub(user.total_spent, 'USD');
        setConvertedTotalSpent(rubAmount);
      } catch (err) {
        console.error('Error converting total spent:', err);
        // Fallback –Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å
        setConvertedTotalSpent(user.total_spent * (usdToRubRate || 90));
      }
    };

    convertTotalSpent();
  }, [user?.total_spent, convertToRub, ratesLoading, usdToRubRate]);

  // üîí –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  useEffect(() => {
    if (isAddingBalance) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }

    return () => {
      document.body.style.overflow = '';
    };
  }, [isAddingBalance]);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ
  const handleCopyOrderInfo = async (purchase: any) => {
    if (!purchase.custom_id) {
      alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
      return;
    }

    setLoadingOrder(prev => ({ ...prev, [purchase.id]: true }));

    try {
      // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
      const orderInfo = await orderService.getOrderInfoByCustomId(purchase.custom_id);
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      const textToCopy = formatOrderInfoForCopy(orderInfo, purchase);
      
      // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
      await navigator.clipboard.writeText(textToCopy);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
      setCopyStatus(prev => ({ ...prev, [purchase.id]: true }));
      setTimeout(() => {
        setCopyStatus(prev => ({ ...prev, [purchase.id]: false }));
      }, 2000);

    } catch (error) {
      console.error('Error copying order info:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ');
    } finally {
      setLoadingOrder(prev => ({ ...prev, [purchase.id]: false }));
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  const formatOrderInfoForCopy = (orderInfo: any, purchase: any): string => {
    const lines = [
      `üõí –î–µ—Ç–∞–ª–∏ –ø–æ–∫—É–ø–∫–∏`,
      `üì¶ –¢–æ–≤–∞—Ä: ${purchase.service_name}`,
      `üí∞ –°—É–º–º–∞: ${purchase.amount} ${purchase.currency}`,
      `üìÖ –î–∞—Ç–∞: ${new Date(purchase.purchase_date).toLocaleDateString('ru-RU')}`,
      `üÜî ID –∑–∞–∫–∞–∑–∞: ${purchase.custom_id}`,
      `üìä –°—Ç–∞—Ç—É—Å: ${orderInfo.status_message}`,
    ];

    // –î–æ–±–∞–≤–ª—è–µ–º PIN –∫–æ–¥—ã –µ—Å–ª–∏ –µ—Å—Ç—å
    if (orderInfo.pins && orderInfo.pins.length > 0) {
      lines.push(`üîë PIN –∫–æ–¥—ã: ${orderInfo.pins.join(', ')}`);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (orderInfo.data) {
      lines.push(`üìù –î–∞–Ω–Ω—ã–µ: ${orderInfo.data}`);
    }

    return lines.join('\n');
  };
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è handleCardLinkPayment
  const handleCardLinkPayment = async () => {
    if (!addAmount || isNaN(Number(addAmount)) || Number(addAmount) <= 0) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
      return;
    }

    if (!user) {
      alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    try {
      setProcessingCardLink(true);
      setPaymentStatus('–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...');
      
      const amount = Number(addAmount);
      const orderId = `balance_${user.id}_${Date.now()}`;
      
      const paymentResult = await cardLinkService.createPayment(
        amount,
        orderId,
        `–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ ${amount} ‚ÇΩ`,
        user.id
      );

      if (paymentResult.success && paymentResult.link_page_url && paymentResult.bill_id) {
        setPaymentStatus('–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã...');
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
        // const paymentWindow = window.open(paymentResult.link_page_url, '_blank', 'width=600,height=700');
        window.location.replace(paymentResult.link_page_url);
        const paymentWindow = true;
        
        if (paymentWindow) {
          // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
          startPaymentStatusCheck(paymentResult.bill_id, amount);
        } else {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞');
          setProcessingCardLink(false);
          setPaymentStatus('');
        }
      } else {
        alert(paymentResult.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞');
        setProcessingCardLink(false);
        setPaymentStatus('');
      }
    } catch (err) {
      console.error('Error processing CardLink payment:', err);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞');
      setProcessingCardLink(false);
      setPaymentStatus('');
    }
  };

  // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
  const startPaymentStatusCheck = (billId: string, amount: number) => {
    let checkCount = 0;
    const maxChecks = 120; // 10 –º–∏–Ω—É—Ç (120 * 5 —Å–µ–∫—É–Ω–¥)
    
    const checkInterval = setInterval(async () => {
      try {
        checkCount++;
        setPaymentStatus(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞...`);
        
        const status = await cardLinkService.checkPaymentStatus(billId);
        
        if (status.success) {
          if (status.is_paid) {
            // –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
            clearInterval(checkInterval);
            setProcessingCardLink(false);
            setPaymentStatus('–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
            const balanceUpdate = {
              amount: amount,
              payment_method: 'cardlink',
            };
            
            if (user) {
              const response = await userApi.updateBalance(user.id, balanceUpdate);
              updateBalance(response.user.balance);
              
              // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
              setTimeout(() => {
                setIsAddingBalance(false);
                setAddAmount('');
                setPaymentStatus('');
                alert(`–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount} ‚ÇΩ`);
              }, 1000);
            }
            
          } else if (status.is_failed) {
            // –ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª
            clearInterval(checkInterval);
            setProcessingCardLink(false);
            setPaymentStatus('–ü–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª');
            
            setTimeout(() => {
              setPaymentStatus('');
            }, 3000);
          }
          // –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
        if (checkCount >= maxChecks) {
          clearInterval(checkInterval);
          setProcessingCardLink(false);
          setPaymentStatus('–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ–∫–ª–æ');
          
          setTimeout(() => {
            setPaymentStatus('');
          }, 3000);
        }
        
      } catch (error) {
        console.error('Error checking payment status:', error);
      }
    }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  };

  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è handleAddBalance
  const handleAddBalance = async () => {
    if (selectedPayment === 'cardlink') {
      await handleCardLinkPayment();
    } else {
      // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã
      if (!addAmount || isNaN(Number(addAmount)) || Number(addAmount) <= 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
        return;
      }

      try {
        setUpdatingBalance(true);
        const amount = Number(addAmount);
        
        const balanceUpdate = {
          amount: amount,
          payment_method: selectedPayment as 'bank_card' | 'yoomoney',
        };

        const userId = user?.id || 1;
        const response = await userApi.updateBalance(userId, balanceUpdate);
        
        updateBalance(response.user.balance);
        
        setIsAddingBalance(false);
        setAddAmount('');
        alert(`–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${amount} ‚ÇΩ`);
      } catch (err) {
        console.error('Error updating balance:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞');
      } finally {
        setUpdatingBalance(false);
      }
    }
  };


  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return '#88FB47';
      case 'pending': return '#F89D09';
      case 'failed': return '#FF4757';
      default: return '#737591';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'completed': return '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
      case 'pending': return '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
      case 'failed': return '–û—à–∏–±–∫–∞';
      default: return status;
    }
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  // const formatCurrency = (amount: number, currency: string, purchaseId?: number) => {
  //   // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
  //   if (purchaseId && convertedAmounts[purchaseId]) {
  //     return formatRubles(convertedAmounts[purchaseId]);
  //   }
    
  //   // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –≤–∞–ª—é—Ç—É
  //   return new Intl.NumberFormat('ru-RU', {
  //     style: 'currency',
  //     currency: currency
  //   }).format(amount);
  // };

  if (loading) {
    return (
      <ProfileContainer>
        <LoadingContainer>
          <Spinner />
          <LoadingText>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</LoadingText>
        </LoadingContainer>
      </ProfileContainer>
    );
  }

  if (error) {
    return (
      <ProfileContainer>
        <ErrorContainer>
          <ErrorIcon>‚ö†Ô∏è</ErrorIcon>
          <ErrorText>{error}</ErrorText>
          <RetryButton onClick={refreshUser}>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</RetryButton>
        </ErrorContainer>
      </ProfileContainer>
    );
  }

  if (!profile || !user) {
    return (
      <ProfileContainer>
        <ErrorContainer>
          <ErrorIcon>üòï</ErrorIcon>
          <ErrorText>–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</ErrorText>
        </ErrorContainer>
      </ProfileContainer>
    );
  }

  const { purchases, totalPurchases } = profile;

  return (
    <ProfileContainer>
      {/* Header Section */}
      <ProfileHeader>
        <UserAvatar>
          <AvatarImage>
            {user.username.split(' ').map((n: string) => n[0]).join('')}
          </AvatarImage>
          <OnlineIndicator />
        </UserAvatar>
        <UserInfo>
          <UserName>{user.username}</UserName>
          <UserEmail>{user.email}</UserEmail>
          <UserJoinDate>–£—á–∞—Å—Ç–Ω–∏–∫ —Å {new Date(user.join_date).toLocaleDateString('ru-RU')}</UserJoinDate>
        </UserInfo>
      </ProfileHeader>

      {/* Balance Section */}
      <BalanceCard>
        <BalanceHeader>
          <BalanceTitle>–ë–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞</BalanceTitle>
          <BalanceActions>
            <AddBalanceButton onClick={() => setIsAddingBalance(true)}>
              <PlusIcon>+</PlusIcon>
              –ü–æ–ø–æ–ª–Ω–∏—Ç—å
            </AddBalanceButton>
          </BalanceActions>
        </BalanceHeader>
        
        <BalanceAmount>
          <BalanceValue>{user.balance.toLocaleString('ru-RU')}</BalanceValue>
          <CurrencySymbol>‚ÇΩ</CurrencySymbol>
        </BalanceAmount>
        
        <BalanceStats>
          <StatItem>
            <StatLabel>–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</StatLabel>
            <StatValue>
              {convertedTotalSpent !== null 
                ? formatRubles(convertedTotalSpent)
                : `${user.total_spent.toLocaleString('ru-RU')} USD`
              }
            </StatValue>
          </StatItem>
          <StatItem>
            <StatLabel>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</StatLabel>
            <StatValue>{totalPurchases}</StatValue>
          </StatItem>
        </BalanceStats>
      </BalanceCard>

      {/* Add Balance Modal */}
      {isAddingBalance && (
        <ModalOverlay onClick={() => setIsAddingBalance(false)}>
          <ModalContent onClick={(e) => e.stopPropagation()}>
            <ModalHeader>
              <ModalTitle>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</ModalTitle>
              <CloseButton onClick={() => setIsAddingBalance(false)}>√ó</CloseButton>
            </ModalHeader>
            
            <ModalBody>
              <AmountInput
                type="number"
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                value={addAmount}
                onChange={(e) => setAddAmount(e.target.value)}
                min="1"
                step="100"
              />
              
              <QuickAmounts>
                <QuickAmount onClick={() => setAddAmount('500')}>500 ‚ÇΩ</QuickAmount>
                <QuickAmount onClick={() => setAddAmount('1000')}>1 000 ‚ÇΩ</QuickAmount>
                <QuickAmount onClick={() => setAddAmount('5000')}>5 000 ‚ÇΩ</QuickAmount>
                <QuickAmount onClick={() => setAddAmount('10000')}>10 000 ‚ÇΩ</QuickAmount>
              </QuickAmounts>
              
              <PaymentMethods>
                {/* –ù–û–í–´–ô –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã CardLink */}
                <PaymentMethod 
                  $isSelected={selectedPayment === 'cardlink'}
                  onClick={() => setSelectedPayment('cardlink')}
                >
                  <PaymentRadio 
                    type="radio" 
                    name="payment" 
                    checked={selectedPayment === 'cardlink'}
                    onChange={() => setSelectedPayment('cardlink')}
                  />
                  <PaymentLabel>
                    <PaymentIcon>üîó</PaymentIcon>
                    <PaymentInfo>
                      <PaymentName>CardLink</PaymentName>
                      <PaymentDescription>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –°–ë–ü</PaymentDescription>
                    </PaymentInfo>
                  </PaymentLabel>
                </PaymentMethod>
                
                {/* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã */}
                {/* <PaymentMethod 
                  $isSelected={selectedPayment === 'card'}
                  onClick={() => setSelectedPayment('card')}
                >
                  <PaymentRadio 
                    type="radio" 
                    name="payment" 
                    checked={selectedPayment === 'card'}
                    onChange={() => setSelectedPayment('card')}
                  />
                  <PaymentLabel>
                    <PaymentIcon>üí≥</PaymentIcon>
                    <PaymentInfo>
                      <PaymentName>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</PaymentName>
                      <PaymentDescription>Visa, Mastercard, –ú–ò–†</PaymentDescription>
                    </PaymentInfo>
                  </PaymentLabel>
                </PaymentMethod> */}
                
                {/* <PaymentMethod 
                  $isSelected={selectedPayment === 'yoomoney'}
                  onClick={() => setSelectedPayment('yoomoney')}
                >
                  <PaymentRadio 
                    type="radio" 
                    name="payment" 
                    checked={selectedPayment === 'yoomoney'}
                    onChange={() => setSelectedPayment('yoomoney')}
                  />
                  <PaymentLabel>
                    <PaymentIcon>ü§ù</PaymentIcon>
                    <PaymentInfo>
                      <PaymentName>–ÆMoney</PaymentName>
                      <PaymentDescription>–ö–æ—à–µ–ª–µ–∫ –ÆMoney</PaymentDescription>
                    </PaymentInfo>
                  </PaymentLabel>
                </PaymentMethod> */}
              </PaymentMethods>
              
              {/* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ */}
              {paymentStatus && (
                <PaymentStatus>
                  <StatusText>{paymentStatus}</StatusText>
                  {processingCardLink && <StatusSpinner />}
                </PaymentStatus>
              )}
            </ModalBody>
            
            <ModalFooter>
              <CancelButton onClick={() => setIsAddingBalance(false)}>
                –û—Ç–º–µ–Ω–∞
              </CancelButton>
              <ConfirmButton 
                onClick={handleAddBalance}
                disabled={updatingBalance || processingCardLink}
              >
                {processingCardLink ? '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...' : 
                updatingBalance ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ...' : 
                selectedPayment === 'cardlink' ? '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ' : '–ü–æ–ø–æ–ª–Ω–∏—Ç—å'}
              </ConfirmButton>
            </ModalFooter>
          </ModalContent>
        </ModalOverlay>
      )}

      {/* Recent Purchases Section */}
      <Section>
        <SectionHeader>
          <SectionTitle>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</SectionTitle>
          <SectionCount>{totalPurchases} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</SectionCount>
        </SectionHeader>
        
        <PurchasesList>
          {purchases.map((purchase) => (
            <PurchaseItem 
                key={purchase.id} 
                onClick={() => handleCopyOrderInfo(purchase)} 
                style={{
                  background: copyStatus[purchase.id] ? 'rgba(136, 251, 71, 0.1)' : undefined,
                  borderColor: copyStatus[purchase.id] ? 'rgba(136, 251, 71, 0.3)' : undefined
              }}>
              <PurchaseIcon>üéÆ</PurchaseIcon>
              
              <PurchaseInfo>
                <PurchaseName>{purchase.service_name}</PurchaseName>
                <PurchaseDate>{formatDate(purchase.purchase_date)}</PurchaseDate>
                {/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—É–º–º—É –º–∞–ª–µ–Ω—å–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º */}
                <OriginalAmount>
                  {new Intl.NumberFormat('ru-RU', {
                    style: 'currency',
                    currency: purchase.currency
                  }).format(purchase.amount)}
                </OriginalAmount>
              </PurchaseInfo>
              
              <PurchaseDetails>
                <PurchaseAmount>
                  {purchase.id in convertedAmounts 
                    ? formatRubles(convertedAmounts[purchase.id])
                    : '–ó–∞–≥—Ä—É–∑–∫–∞...'
                  }
                </PurchaseAmount>
                <PurchaseStatus $color={getStatusColor(purchase.status)}>
                  {getStatusText(purchase.status)}
                </PurchaseStatus>

                <CopyIndicator>
                  {loadingOrder[purchase.id] ? (
                    <CopySpinner />
                  ) : copyStatus[purchase.id] ? (
                    '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'
                  ) : (
                    'üìã –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è'
                  )}
                </CopyIndicator>
              </PurchaseDetails>
            </PurchaseItem>
          ))}
        </PurchasesList>
        
        {purchases.length === 0 && (
          <EmptyState>
            <EmptyIcon>üõí</EmptyIcon>
            <EmptyText>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫</EmptyText>
            <EmptySubtext>–°–æ–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</EmptySubtext>
          </EmptyState>
        )}
      </Section>
    </ProfileContainer>
  );
};

export default ProfilePage;

// Animations
const fadeIn = keyframes`
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
`;

const slideIn = keyframes`
  from { 
    opacity: 0; 
    transform: translateY(-20px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
`;

const pulse = keyframes`
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
`;

// Styles
const ProfileContainer = styled.div`
  max-width: 800px;
  margin: 0 auto;
  animation: ${fadeIn} 0.6s ease-out;
`;

const ProfileHeader = styled.div`
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 30px;
  padding: 18px 12px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  backdrop-filter: blur(10px);

  @media (max-width: 768px) {
    flex-direction: column;
    text-align: center;
    padding: 20px;
  }
`;

const UserAvatar = styled.div`
  position: relative;
  flex-shrink: 0;
`;

const AvatarImage = styled.div`
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-family: "ChakraPetch-Regular";
  font-size: 24px;
  font-weight: bold;
`;

const OnlineIndicator = styled.div`
  position: absolute;
  bottom: 5px;
  right: 5px;
  width: 16px;
  height: 16px;
  background: #88FB47;
  border: 2px solid #1a1a2e;
  border-radius: 50%;
`;

const UserInfo = styled.div`
  flex: 1;
`;

const UserName = styled.h1`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 24px;
  margin: 0 0 8px 0;
`;

const UserEmail = styled.p`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  margin: 0 0 4px 0;
`;

const UserJoinDate = styled.p`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  margin: 0;
`;

const BalanceCard = styled.div`
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 18px 12px;
  margin-bottom: 30px;
  backdrop-filter: blur(10px);
  animation: ${slideIn} 0.6s ease-out;
`;

const BalanceHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;

  @media (max-width: 768px) {
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
`;

const BalanceTitle = styled.h2`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 18px;
  margin: 0;
`;

const BalanceActions = styled.div`
  display: flex;
  gap: 10px;
`;

const AddBalanceButton = styled.button`
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  border: none;
  border-radius: 10px;
  padding: 10px 20px;
  color: white;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(136, 251, 71, 0.3);
    animation: ${pulse} 0.5s ease-in-out;
  }
`;

const PlusIcon = styled.span`
  font-size: 18px;
  font-weight: bold;
`;

const BalanceAmount = styled.div`
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 20px;
  overflow: hidden;
`;

const BalanceValue = styled.span`
  color: #fff;
  font-family: "Jura-Regular";
  font-size: 42px;
  font-weight: bold;
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
`;

const CurrencySymbol = styled.span`
  color: #88FB47;
  font-family: "Jura-Regular";
  font-size: 24px;
  font-weight: bold;
`;

const BalanceStats = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  padding-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
`;

const StatItem = styled.div`
  display: flex;
  flex-direction: column;
  gap: 4px;
`;

const StatLabel = styled.span`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
`;

const StatValue = styled.span`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 18px;
  font-weight: 600;
`;

const Section = styled.div`
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 18px 12px;
  margin-bottom: 30px;
  backdrop-filter: blur(10px);
`;

const SectionHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;

  @media (max-width: 768px) {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
`;

const SectionTitle = styled.h2`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 20px;
  margin: 0;
`;

const SectionCount = styled.span`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
`;

const PurchasesList = styled.div`
  display: flex;
  flex-direction: column;
  gap: 15px;
`;

const PurchaseItem = styled.div`
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.05);
  border-radius: 15px;
  transition: all 0.3s ease;
  cursor: pointer;

  &:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }
`;

const PurchaseIcon = styled.div`
  width: 50px;
  height: 50px;
  background: rgba(136, 251, 71, 0.1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
`;

const PurchaseInfo = styled.div`
  flex: 1;
`;

const PurchaseName = styled.h3`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  margin: 0 0 4px 0;
`;

const PurchaseDate = styled.span`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
`;

const PurchaseDetails = styled.div`
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
  min-width: 120px;
`;

const PurchaseAmount = styled.span`
  color: #88FB47;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  font-weight: 600;
`;

const PurchaseStatus = styled.span<{ $color: string }>`
  color: ${props => props.$color};
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
  font-weight: 600;
  padding: 4px 8px;
  background: ${props => `${props.$color}20`};
  border-radius: 6px;
`;

const EmptyState = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
`;

const EmptyIcon = styled.div`
  font-size: 64px;
  margin-bottom: 20px;
`;

const EmptyText = styled.h3`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 18px;
  margin: 0 0 8px 0;
`;

const EmptySubtext = styled.p`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  margin: 0;
`;


// Modal Styles
const ModalOverlay = styled.div`
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto; /* –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ */
`;

const ModalContent = styled.div`
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border-radius: 20px;
  padding: 0;
  max-width: 500px;
  width: 100%;
  max-height: calc(100vh - 40px); /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
  overflow-y: auto; /* –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  animation: ${slideIn} 0.3s ease-out;
`;

const ModalHeader = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
`;

const ModalTitle = styled.h2`
  color: #fff;
  font-size: 20px;
  font-weight: 600;
  font-family: "ChakraPetch-Regular";
  margin: 0;
`;

const CloseButton = styled.button`
  background: none;
  border: none;
  color: #fff;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background-color 0.3s ease;

  &:hover {
    background: rgba(255, 255, 255, 0.1);
  }
`;

const ModalBody = styled.div`
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
`;

const AmountInput = styled.input<{ $hasError?: boolean }>`
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid ${props => props.$hasError ? '#ff4757' : 'rgba(255, 255, 255, 0.2)'};
  border-radius: 10px;
  padding: 16px;
  color: #fff;
  font-family: "Oxanium-Regular";
  font-size: 18px;
  width: 100%; /* ‚Üê –î–û–ë–ê–í–ò–¢–¨ */
  box-sizing: border-box; /* ‚Üê –î–û–ë–ê–í–ò–¢–¨ */
  transition: all 0.3s ease;

  &:focus {
    outline: none;
    border-color: ${props => props.$hasError ? '#ff4757' : '#88FB47'};
    box-shadow: 0 0 0 2px ${props => props.$hasError ? 'rgba(255, 71, 87, 0.2)' : 'rgba(136, 251, 71, 0.2)'};
  }

  &::placeholder {
    color: #737591;
  }

  /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É number input */
  &::-webkit-outer-spin-button,
  &::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  /* –î–ª—è Firefox */
  &[type=number] {
    -moz-appearance: textfield;
  }
`;

const QuickAmounts = styled.div`
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 24px;

  @media (max-width: 480px) {
    grid-template-columns: 1fr;
  }
`;

const QuickAmount = styled.button`
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 12px;
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    background: rgba(136, 251, 71, 0.1);
    border-color: #88FB47;
  }
`;

const PaymentMethods = styled.div`
  display: flex;
  flex-direction: column;
  gap: 12px;
`;

const PaymentMethod = styled.div<{ $isSelected?: boolean }>`
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: ${props => props.$isSelected ? 'rgba(136, 251, 71, 0.1)' : 'rgba(255, 255, 255, 0.05)'};
  border: 1px solid ${props => props.$isSelected ? '#88FB47' : 'rgba(255, 255, 255, 0.1)'};
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.2);
  }
`;

const PaymentRadio = styled.input`
  margin: 0;
`;

const PaymentLabel = styled.label`
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  cursor: pointer;
`;

const PaymentIcon = styled.div`
  font-size: 24px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
`;

const PaymentInfo = styled.div`
  flex: 1;
`;

const PaymentName = styled.div`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 2px;
`;

const PaymentDescription = styled.div`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
`;

const ModalFooter = styled.div`
  display: flex;
  gap: 12px;
  padding: 12px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
`;

const CancelButton = styled.button`
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 12px 24px;
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  cursor: pointer;
  flex: 1;
  transition: all 0.3s ease;

  &:hover {
    background: rgba(255, 255, 255, 0.15);
  }
`;

const ConfirmButton = styled.button`
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  border: none;
  border-radius: 10px;
  padding: 12px 24px;
  color: white;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  flex: 1;
  transition: all 0.3s ease;

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(136, 251, 71, 0.3);
  }
`;

// –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫
const Spinner = styled.div`
  width: 50px;
  height: 50px;
  border: 4px solid rgba(136, 251, 71, 0.3);
  border-top: 4px solid #88FB47;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;

const LoadingContainer = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 100px 20px;
  gap: 20px;
`;

const LoadingText = styled.span`
  color: #88FB47;
  font-size: 16px;
  font-family: "ChakraPetch-Regular";
`;

const ErrorContainer = styled.div`
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 100px 20px;
  text-align: center;
  gap: 20px;
`;

const ErrorIcon = styled.div`
  font-size: 64px;
`;

const ErrorText = styled.span`
  color: #fff;
  font-size: 18px;
  font-family: "ChakraPetch-Regular";
`;

const RetryButton = styled.button`
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  border: none;
  border-radius: 10px;
  padding: 12px 24px;
  color: white;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(136, 251, 71, 0.3);
  }
`;

const PaymentStatus = styled.div`
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 12px;
  background: rgba(136, 251, 71, 0.1);
  border: 1px solid rgba(136, 251, 71, 0.3);
  border-radius: 10px;
  margin: 10px 0;
`;

const StatusText = styled.span`
  color: #88FB47;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
`;

const StatusSpinner = styled.div`
  width: 16px;
  height: 16px;
  border: 2px solid rgba(136, 251, 71, 0.3);
  border-top: 2px solid #88FB47;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;


const CopyIndicator = styled.div`
  color: #88FB47;
  font-family: "ChakraPetch-Regular";
  font-size: 11px;
  text-align: center;
  margin-top: 8px;
  padding: 4px 8px;
  background: rgba(136, 251, 71, 0.1);
  border-radius: 6px;
  transition: all 0.3s ease;
`;

const CopySpinner = styled.div`
  width: 12px;
  height: 12px;
  border: 2px solid rgba(136, 251, 71, 0.3);
  border-top: 2px solid #88FB47;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto;
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;

const OriginalAmount = styled.div`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
  margin-top: 2px;
`;


/games-stuff-shop/src/pages/ShopCart.tsx:
import React, { useState, useEffect } from 'react';
import styled from 'styled-components';
import { useCart } from '../context/CartContext';
import { useOrders } from '../hooks/useOrders';
import { useCurrency } from '../hooks/useCurrency';
import { type CheckoutItemResult } from '../services/orderService';

const ShopCartPage: React.FC = () => {
    const { state, updateQuantity, removeItem, clearCart, updateUserData, requiresUserData } = useCart();
    const { items, total } = state;
    const { checkout, loading, error, result, validateCheckout, getStatusColor } = useOrders();
    const { convertToRub, formatRubles, usdToRubRate, loading: ratesLoading } = useCurrency();

    const [showCheckoutModal, setShowCheckoutModal] = useState(false);
    const [convertedPrices, setConvertedPrices] = useState<{ [key: number]: number }>({});
    const [convertedTotal, setConvertedTotal] = useState<number>(0);
    const [convertedResultTotal, setConvertedResultTotal] = useState<number | null>(null);

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ä—É–±–ª–∏
    useEffect(() => {
        const convertPrices = async () => {
            const prices: { [key: number]: number } = {};
            let totalRub = 0;

            for (const item of items) {
                try {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –∑–∞ –µ–¥–∏–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
                    const rubPrice = await convertToRub(item.price || 0, item.currency || 'USD');
                    prices[item.service_id] = rubPrice;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–µ–π —Å—É–º–º–µ (—Ü–µ–Ω–∞ √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
                    totalRub += rubPrice * item.quantity;
                } catch (err) {
                    console.error(`Error converting price for item ${item.service_id}:`, err);
                    // Fallback –Ω–∞ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å
                    const fallbackPrice = (item.price || 0) * (usdToRubRate || 90);
                    prices[item.service_id] = fallbackPrice;
                    totalRub += fallbackPrice * item.quantity;
                }
            }

            setConvertedPrices(prices);
            setConvertedTotal(totalRub);
        };

        if (items.length > 0 && !ratesLoading) {
            convertPrices();
        } else {
            setConvertedPrices({});
            setConvertedTotal(0);
        }
    }, [items, convertToRub, ratesLoading, usdToRubRate]);

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±—â–µ–π —Å—É–º–º—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–∫–∞–∑–∞
    useEffect(() => {
        const convertResultTotal = async () => {
            if (result?.data.total_amount) {
                try {
                    const rubAmount = await convertToRub(result.data.total_amount, 'USD');
                    setConvertedResultTotal(rubAmount);
                } catch (err) {
                    console.error('Error converting result total:', err);
                    setConvertedResultTotal(result.data.total_amount * (usdToRubRate || 90));
                }
            }
        };

        if (result) {
            convertResultTotal();
        }
    }, [result, convertToRub, usdToRubRate]);

    const handleQuantityChange = (serviceId: number, newQuantity: number) => {
        if (newQuantity <= 0) {
            removeItem(serviceId);
        } else {
            updateQuantity(serviceId, newQuantity);
        }
    };

    const handleRemoveItem = (serviceId: number) => {
        removeItem(serviceId);
    };

    const handleUserDataChange = (serviceId: number, value: string) => {
        updateUserData(serviceId, value);
    };

    const handleCheckout = async () => {
        if (items.length === 0) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        const validationError = validateCheckout(items);
        if (validationError) {
            alert(validationError);
            return;
        }

        setShowCheckoutModal(true);
        
        try {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const userId = 1; // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID 1 –¥–ª—è —Ç–µ—Å—Ç–∞
            
            await checkout(userId, items);
            
            window.location.replace('/');
        } catch (err) {
            console.error('Checkout error:', err);
            // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ —Ö—É–∫–µ useOrders
        }
    };

    const handleCloseModal = () => {
        setShowCheckoutModal(false);
        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –∑–∞–∫–∞–∑—ã —É—Å–ø–µ—à–Ω—ã
        if (result && result.data.total_failed === 0) {
            clearCart();
        }
    };

    const handleRetryCheckout = () => {
        setShowCheckoutModal(false);
        // –î–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    };

    const getStatusMessage = (status: number): string => {
        switch (status) {
            case 2: return '‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ';
            case 3: return '‚ùå –û—à–∏–±–∫–∞';
            default: return '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
        }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –≤–∞–ª—é—Ç—ã
    const formatPriceWithOriginal = (price: number, currency: string, serviceId: number) => {
        const rubPrice = convertedPrices[serviceId];
        const totalRub = rubPrice ? rubPrice * (items.find(item => item.service_id === serviceId)?.quantity || 1) : 0;
        
        return (
            <PriceContainer>
                <RubPrice>
                    {rubPrice ? formatRubles(totalRub) : '–ó–∞–≥—Ä—É–∑–∫–∞...'}
                </RubPrice>
                <OriginalPrice>
                    {price} {currency} √ó {items.find(item => item.service_id === serviceId)?.quantity || 1} = {(price * (items.find(item => item.service_id === serviceId)?.quantity || 1)).toFixed(2)} {currency}
                </OriginalPrice>
            </PriceContainer>
        );
    };

    if (items.length === 0 && !showCheckoutModal) {
        return (
            <CartContainer>
                <CartHeader>
                    <CartTitle>–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫</CartTitle>
                </CartHeader>
                <EmptyCart>
                    <EmptyCartIcon>üõí</EmptyCartIcon>
                    <EmptyCartText>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</EmptyCartText>
                    <EmptyCartSubtext>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</EmptyCartSubtext>
                </EmptyCart>
            </CartContainer>
        );
    }

    return (
        <>
            <CartContainer>
                <CartHeader>
                    <CartTitle>–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫</CartTitle>
                    <ClearCartButton onClick={clearCart}>
                        –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
                    </ClearCartButton>
                </CartHeader>

                <CartItems>
                    {items.map((item) => (
                        <CartItem key={item.service_id}>
                            <ItemInfo>
                                <ItemName>{item.service_name}</ItemName>
                                {item.service_description && (
                                    <ItemDescription>{item.service_description}</ItemDescription>
                                )}
                                <ItemPrice>
                                    {formatPriceWithOriginal(item.price || 0, item.currency || 'USD', item.service_id)}
                                </ItemPrice>
                                
                                {/* –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è */}
                                {requiresUserData(item.service_name) && (
                                    <DataInputContainer>
                                        <DataInputLabel>
                                            {item.service_name.includes('Steam') ? 'Steam –ª–æ–≥–∏–Ω' : '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'} *
                                        </DataInputLabel>
                                        <DataInput
                                            type="text"
                                            placeholder={item.service_name.includes('Steam') ? '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Steam –ª–æ–≥–∏–Ω' : '–í–≤–µ–¥–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ'}
                                            value={item.userData || ''}
                                            onChange={(e) => handleUserDataChange(item.service_id, e.target.value)}
                                        />
                                        <DataInputHint>
                                            * –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
                                        </DataInputHint>
                                    </DataInputContainer>
                                )}
                            </ItemInfo>
                            
                            <ItemControls>
                                <QuantityControl>
                                    <QuantityButton 
                                        onClick={() => handleQuantityChange(item.service_id, item.quantity - 1)}
                                        disabled={loading}
                                    >
                                        -
                                    </QuantityButton>
                                    <QuantityDisplay>{item.quantity}</QuantityDisplay>
                                    <QuantityButton 
                                        onClick={() => handleQuantityChange(item.service_id, item.quantity + 1)}
                                        disabled={loading}
                                    >
                                        +
                                    </QuantityButton>
                                </QuantityControl>
                                <RemoveButton 
                                    onClick={() => handleRemoveItem(item.service_id)}
                                    disabled={loading}
                                >
                                    –£–¥–∞–ª–∏—Ç—å
                                </RemoveButton>
                            </ItemControls>
                        </CartItem>
                    ))}
                </CartItems>

                <CartSummary>
                    <TotalSummary>
                        <SummaryRow>
                            <SummaryLabel>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤:</SummaryLabel>
                            <SummaryValue>
                                {items.reduce((total, item) => total + item.quantity, 0)}
                            </SummaryValue>
                        </SummaryRow>
                        <SummaryRow>
                            <SummaryLabel>–û–±—â–∞—è —Å—É–º–º–∞:</SummaryLabel>
                            <SummaryValue>
                                {convertedTotal > 0 ? formatRubles(convertedTotal) : '–ó–∞–≥—Ä—É–∑–∫–∞...'}
                                <OriginalTotal>
                                    {total.toFixed(2)} USD
                                </OriginalTotal>
                            </SummaryValue>
                        </SummaryRow>
                    </TotalSummary>
                    
                    <CheckoutButton 
                        onClick={handleCheckout}
                        disabled={loading || items.length === 0 || ratesLoading}
                    >
                        {loading ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : 
                         ratesLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–∞...' : 
                         `–ö—É–ø–∏—Ç—å –∑–∞ ${formatRubles(convertedTotal)}`}
                    </CheckoutButton>
                </CartSummary>
            </CartContainer>

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–∫–∞–∑–∞ */}
            {showCheckoutModal && (
                <ModalOverlay>
                    <ModalContent>
                        <ModalHeader>
                            <ModalTitle>
                                {loading ? '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–∞...' : '–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–∫–∞–∑–∞'}
                            </ModalTitle>
                            <CloseButton onClick={handleCloseModal}>√ó</CloseButton>
                        </ModalHeader>
                        
                        <ModalBody>
                            {loading && (
                                <LoadingMessage>
                                    <Spinner />
                                    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∞—à –∑–∞–∫–∞–∑...
                                    <LoadingSubtext>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</LoadingSubtext>
                                </LoadingMessage>
                            )}
                            
                            {error && (
                                <ErrorMessage>
                                    <ErrorIcon>‚ùå</ErrorIcon>
                                    <ErrorMessageContent>
                                        <ErrorMessageTitle>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</ErrorMessageTitle>
                                        <ErrorMessageText>{error}</ErrorMessageText>
                                    </ErrorMessageContent>
                                </ErrorMessage>
                            )}
                            
                            {result && (
                                <ResultsContainer>
                                    <ResultsHeader success={result.data.total_failed === 0}>
                                        <ResultsTitle>
                                            {result.data.total_failed === 0 ? '‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!' : '‚ö†Ô∏è –ó–∞–∫–∞–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å –æ—à–∏–±–∫–∞–º–∏'}
                                        </ResultsTitle>
                                        <ResultsSummary>
                                            <SummaryItem success>
                                                –£—Å–ø–µ—à–Ω–æ: {result.data.total_processed}
                                            </SummaryItem>
                                            {result.data.total_failed > 0 && (
                                                <SummaryItem error>
                                                    –û—à–∏–±–æ–∫: {result.data.total_failed}
                                                </SummaryItem>
                                            )}
                                            <SummaryItem>
                                                –°—É–º–º–∞: {convertedResultTotal !== null ? formatRubles(convertedResultTotal) : '–ó–∞–≥—Ä—É–∑–∫–∞...'}
                                                <OriginalAmount>
                                                    {result.data.total_amount.toFixed(2)} USD
                                                </OriginalAmount>
                                            </SummaryItem>
                                        </ResultsSummary>
                                    </ResultsHeader>
                                    
                                    <ResultsList>
                                        {result.data.results.map((item: CheckoutItemResult, index: number) => (
                                            <ResultItem key={index} success={item.success}>
                                                <ResultHeader>
                                                    <ResultService>{item.service_name}</ResultService>
                                                    <ResultStatus style={{ color: getStatusColor(item.status) }}>
                                                        {getStatusMessage(item.status)}
                                                    </ResultStatus>
                                                </ResultHeader>
                                                
                                                {item.pins && item.pins.length > 0 && (
                                                    <ResultDetails>
                                                        <ResultLabel>–ö–æ–¥—ã:</ResultLabel>
                                                        <ResultPins>
                                                            {item.pins.map((pin, pinIndex) => (
                                                                <PinCode key={pinIndex}>{pin}</PinCode>
                                                            ))}
                                                        </ResultPins>
                                                    </ResultDetails>
                                                )}
                                                
                                                {item.data && (
                                                    <ResultDetails>
                                                        <ResultLabel>–î–∞–Ω–Ω—ã–µ:</ResultLabel>
                                                        <ResultData>{item.data}</ResultData>
                                                    </ResultDetails>
                                                )}
                                                
                                                {item.error && (
                                                    <ResultDetails>
                                                        <ResultLabel>–û—à–∏–±–∫–∞:</ResultLabel>
                                                        <ResultError>{item.error}</ResultError>
                                                    </ResultDetails>
                                                )}
                                            </ResultItem>
                                        ))}
                                    </ResultsList>
                                </ResultsContainer>
                            )}
                        </ModalBody>
                        
                        <ModalFooter>
                            {result && result.data.total_failed > 0 ? (
                                <>
                                    <ModalButton secondary onClick={handleRetryCheckout}>
                                        –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
                                    </ModalButton>
                                    <ModalButton onClick={handleCloseModal}>
                                        –ü–æ–Ω—è—Ç–Ω–æ
                                    </ModalButton>
                                </>
                            ) : (
                                <ModalButton onClick={handleCloseModal}>
                                    {result ? '–û—Ç–ª–∏—á–Ω–æ!' : '–ó–∞–∫—Ä—ã—Ç—å'}
                                </ModalButton>
                            )}
                        </ModalFooter>
                    </ModalContent>
                </ModalOverlay>
            )}
        </>
    );
};

export default ShopCartPage;

// Styles
const CartContainer = styled.div`
    max-width: 800px;
    margin: 0 auto;
    animation: fadeIn 0.5s ease-out;

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;

const CartHeader = styled.div`
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
`;

const CartTitle = styled.h1`
    color: #fff;
    font-family: "ChakraPetch-Regular";
    font-size: 24px;
    margin: 0;
`;

const ClearCartButton = styled.button`
    background: rgba(255, 59, 59, 0.2);
    color: #ff3b3b;
    border: 1px solid #ff3b3b;
    border-radius: 5px;
    padding: 8px 16px;
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
        background: rgba(255, 59, 59, 0.3);
    }
`;

const CartItems = styled.div`
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
`;

const CartItem = styled.div`
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    transition: all 0.3s ease;

    &:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
    }
`;

const ItemInfo = styled.div`
    flex: 1;
`;

const ItemName = styled.h3`
    color: #fff;
    font-family: "ChakraPetch-Regular";
    font-size: 18px;
    margin: 0 0 8px 0;
`;

const ItemDescription = styled.p`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
    margin: 0 0 8px 0;
`;

const ItemPrice = styled.div`
    margin-top: 8px;
`;

const PriceContainer = styled.div`
    display: flex;
    flex-direction: column;
    gap: 4px;
`;

const RubPrice = styled.div`
    color: #88FB47;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    font-weight: 600;
`;

const OriginalPrice = styled.div`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
`;

const DataInputContainer = styled.div`
    margin-top: 12px;
    margin-right: 10px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.1);
`;

const DataInputLabel = styled.label`
    display: block;
    color: #88FB47;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 6px;
`;

const DataInput = styled.input`
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    padding: 10px 12px;
    color: white;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    box-sizing: border-box;
    
    &::placeholder {
        color: #737591;
    }
    
    &:focus {
        outline: none;
        border-color: #88FB47;
        box-shadow: 0 0 0 2px rgba(136, 251, 71, 0.2);
    }
`;

const DataInputHint = styled.span`
    display: block;
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 10px;
    margin-top: 4px;
`;

const ItemControls = styled.div`
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
`;

const QuantityControl = styled.div`
    display: flex;
    align-items: center;
    background: rgba(248, 157, 9, 0.2);
    border: 1px solid #F89D09;
    border-radius: 5px;
    overflow: hidden;
`;

const QuantityButton = styled.button`
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    padding: 8px 12px;
    transition: background-color 0.3s ease;

    &:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.1);
    }

    &:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
`;

const QuantityDisplay = styled.span`
    color: white;
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
    font-weight: 600;
    padding: 8px 16px;
    min-width: 40px;
    text-align: center;
`;

const RemoveButton = styled.button`
    width: 100%;
    background: rgba(255, 59, 59, 0.1);
    color: #ff3b3b;
    border: 1px solid #ff3b3b;
    border-radius: 5px;
    padding: 6px 12px;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover:not(:disabled) {
        background: rgba(255, 59, 59, 0.2);
    }

    &:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
`;

const CartSummary = styled.div`
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 25px;
`;

const TotalSummary = styled.div`
    margin-bottom: 20px;
`;

const SummaryRow = styled.div`
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;

    &:last-child {
        margin-bottom: 0;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 18px;
        font-weight: bold;
    }
`;

const SummaryLabel = styled.span`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
`;

const SummaryValue = styled.span`
    color: #88FB47;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
`;

const OriginalTotal = styled.span`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    font-weight: normal;
`;

const CheckoutButton = styled.button`
    width: 100%;
    background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 16px;
    font-family: "ChakraPetch-Regular";
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(136, 251, 71, 0.3);
    }

    &:active {
        transform: translateY(0);
    }

    &:disabled {
        background: #737591;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
`;

const EmptyCart = styled.div`
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
`;

const EmptyCartIcon = styled.div`
    font-size: 64px;
    margin-bottom: 20px;
`;

const EmptyCartText = styled.h2`
    color: #fff;
    font-family: "ChakraPetch-Regular";
    font-size: 24px;
    margin: 0 0 10px 0;
`;

const EmptyCartSubtext = styled.p`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    margin: 0;
`;

// –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
const ModalOverlay = styled.div`
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease-out;

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
`;

const ModalContent = styled.div`
    background: #1a1a2e;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 0;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;

const ModalHeader = styled.div`
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
`;

const ModalTitle = styled.h2`
    color: #fff;
    font-family: "ChakraPetch-Regular";
    font-size: 20px;
    margin: 0;
`;

const CloseButton = styled.button`
    background: none;
    border: none;
    color: #737591;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    
    &:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }
`;

const ModalBody = styled.div`
    padding: 25px;
    max-height: 400px;
    overflow-y: auto;
`;

const ModalFooter = styled.div`
    padding: 20px 25px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
`;

const ModalButton = styled.button<{ secondary?: boolean }>`
    background: ${props => props.secondary 
        ? 'rgba(255, 255, 255, 0.1)' 
        : 'linear-gradient(135deg, #88FB47 0%, #27C151 100%)'};
    color: ${props => props.secondary ? '#fff' : 'white'};
    border: ${props => props.secondary ? '1px solid rgba(255, 255, 255, 0.2)' : 'none'};
    border-radius: 8px;
    padding: 12px 24px;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;

    &:hover {
        transform: translateY(-2px);
        box-shadow: ${props => props.secondary 
            ? '0 5px 15px rgba(255, 255, 255, 0.1)' 
            : '0 5px 15px rgba(136, 251, 71, 0.3)'};
    }
`;

const LoadingMessage = styled.div`
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    color: #F89D09;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    text-align: center;
    padding: 20px;
`;

const Spinner = styled.div`
    width: 40px;
    height: 40px;
    border: 3px solid rgba(248, 157, 9, 0.3);
    border-top: 3px solid #F89D09;
    border-radius: 50%;
    animation: spin 1s linear infinite;

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;

const LoadingSubtext = styled.div`
    color: #737591;
    font-size: 14px;
`;

const ErrorMessage = styled.div`
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: rgba(255, 59, 59, 0.1);
    border: 1px solid rgba(255, 59, 59, 0.3);
    border-radius: 8px;
    padding: 20px;
`;

const ErrorIcon = styled.div`
    font-size: 24px;
    flex-shrink: 0;
    margin-top: 2px;
`;

const ErrorMessageContent = styled.div`
    flex: 1;
`;

const ErrorMessageTitle = styled.div`
    color: #ff3b3b;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
`;

const ErrorMessageText = styled.div`
    color: #ff3b3b;
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
    line-height: 1.4;
`;

const ResultsContainer = styled.div`
    display: flex;
    flex-direction: column;
    gap: 20px;
`;

const ResultsHeader = styled.div<{ success: boolean }>`
    background: ${props => props.success 
        ? 'rgba(136, 251, 71, 0.1)' 
        : 'rgba(248, 157, 9, 0.1)'};
    border: 1px solid ${props => props.success 
        ? 'rgba(136, 251, 71, 0.3)' 
        : 'rgba(248, 157, 9, 0.3)'};
    border-radius: 10px;
    padding: 20px;
`;

const ResultsTitle = styled.h3`
    color: #fff;
    font-family: "ChakraPetch-Regular";
    font-size: 18px;
    margin: 0 0 15px 0;
    text-align: center;
`;

const ResultsSummary = styled.div`
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
`;

const SummaryItem = styled.div<{ success?: boolean; error?: boolean }>`
    background: ${props => {
        if (props.success) return 'rgba(136, 251, 71, 0.2)';
        if (props.error) return 'rgba(255, 59, 59, 0.2)';
        return 'rgba(255, 255, 255, 0.1)';
    }};
    color: ${props => {
        if (props.success) return '#88FB47';
        if (props.error) return '#ff3b3b';
        return '#fff';
    }};
    border: 1px solid ${props => {
        if (props.success) return 'rgba(136, 251, 71, 0.3)';
        if (props.error) return 'rgba(255, 59, 59, 0.3)';
        return 'rgba(255, 255, 255, 0.2)';
    }};
    border-radius: 8px;
    padding: 10px 15px;
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
`;

const OriginalAmount = styled.span`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 10px;
    font-weight: normal;
`;

const ResultsList = styled.div`
    display: flex;
    flex-direction: column;
    gap: 12px;
`;

const ResultItem = styled.div<{ success: boolean }>`
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid ${props => props.success 
        ? 'rgba(136, 251, 71, 0.2)' 
        : 'rgba(255, 59, 59, 0.2)'};
    border-radius: 8px;
    padding: 15px;
`;

const ResultHeader = styled.div`
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
`;

const ResultService = styled.div`
    color: #fff;
    font-family: "ChakraPetch-Regular";
    font-size: 16px;
    font-weight: 600;
`;

const ResultStatus = styled.div`
    font-family: "ChakraPetch-Regular";
    font-size: 14px;
    font-weight: 600;
`;

const ResultDetails = styled.div`
    margin-top: 8px;
    display: flex;
    gap: 8px;
    align-items: flex-start;
`;

const ResultLabel = styled.div`
    color: #737591;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    font-weight: 600;
    min-width: 60px;
    flex-shrink: 0;
`;

const ResultPins = styled.div`
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
`;

const PinCode = styled.div`
    background: rgba(136, 251, 71, 0.1);
    color: #88FB47;
    border: 1px solid rgba(136, 251, 71, 0.3);
    border-radius: 4px;
    padding: 6px 10px;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    font-weight: 600;
    word-break: break-all;
`;

const ResultData = styled.div`
    color: #88FB47;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    flex: 1;
    word-break: break-all;
`;

const ResultError = styled.div`
    color: #ff3b3b;
    font-family: "ChakraPetch-Regular";
    font-size: 12px;
    flex: 1;
    word-break: break-all;
`;


/games-stuff-shop/src/pages/Support.tsx:
import React, { useState } from 'react';
import styled, { keyframes } from 'styled-components';

interface SupportForm {
  name: string;
  email: string;
  subject: string;
  message: string;
  priority: 'low' | 'medium' | 'high';
}

const SupportPage: React.FC = () => {
  const [formData, setFormData] = useState<SupportForm>({
    name: '',
    email: '',
    subject: '',
    message: '',
    priority: 'medium'
  });
  
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [errors, setErrors] = useState<Partial<SupportForm>>({});

  const validateForm = (): boolean => {
    const newErrors: Partial<SupportForm> = {};

    if (!formData.name.trim()) {
      newErrors.name = '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
    }

    if (!formData.email.trim()) {
      newErrors.email = 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
    } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
      newErrors.email = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å';
    }

    if (!formData.subject.trim()) {
      newErrors.subject = '–¢–µ–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
    }

    if (!formData.message.trim()) {
      newErrors.message = '–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
    } else if (formData.message.length < 10) {
      newErrors.message = '–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>
  ) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
    
    // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –≤–≤–æ–¥–µ
    if (errors[name as keyof SupportForm]) {
      setErrors(prev => ({
        ...prev,
        [name]: undefined
      }));
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!validateForm()) {
      return;
    }

    setIsSubmitting(true);

    // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    try {
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã API –≤—ã–∑–æ–≤
      console.log('Form submitted:', formData);
      
      setIsSubmitted(true);
      setFormData({
        name: '',
        email: '',
        subject: '',
        message: '',
        priority: 'medium'
      });
    } catch (error) {
      console.error('Error submitting form:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleNewTicket = () => {
    setIsSubmitted(false);
  };

  if (isSubmitted) {
    return (
      <SupportContainer>
        <SuccessMessage>
          <SuccessIcon>‚úì</SuccessIcon>
          <SuccessTitle>–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!</SuccessTitle>
          <SuccessText>
            –í–∞—à –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É. 
            –ù–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É email.
          </SuccessText>
          <SuccessDetails>
            <DetailItem>
              <DetailLabel>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:</DetailLabel>
              <DetailValue>#{Math.random().toString(36).substr(2, 9).toUpperCase()}</DetailValue>
            </DetailItem>
            <DetailItem>
              <DetailLabel>–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏:</DetailLabel>
              <DetailValue>{new Date().toLocaleString('ru-RU')}</DetailValue>
            </DetailItem>
          </SuccessDetails>
          <NewTicketButton onClick={handleNewTicket}>
            –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
          </NewTicketButton>
        </SuccessMessage>
      </SupportContainer>
    );
  }

  return (
    <SupportContainer>
      <SupportHeader>
        <SupportTitle>–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</SupportTitle>
        <SupportSubtitle>
          –ú—ã –∑–¥–µ—Å—å —á—Ç–æ–±—ã –ø–æ–º–æ—á—å! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ –∏ –º—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.
        </SupportSubtitle>
      </SupportHeader>

      <SupportFormContainer onSubmit={handleSubmit}>
        <FormGrid>
          <FormGroup>
            <Label htmlFor="name">
              –í–∞—à–µ –∏–º—è <Required>*</Required>
            </Label>
            <Input
              type="text"
              id="name"
              name="name"
              value={formData.name}
              onChange={handleInputChange}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
              $hasError={!!errors.name}
            />
            {errors.name && <ErrorText>{errors.name}</ErrorText>}
          </FormGroup>

          <FormGroup>
            <Label htmlFor="email">
              Email –∞–¥—Ä–µ—Å <Required>*</Required>
            </Label>
            <Input
              type="email"
              id="email"
              name="email"
              value={formData.email}
              onChange={handleInputChange}
              placeholder="your@email.com"
              $hasError={!!errors.email}
            />
            {errors.email && <ErrorText>{errors.email}</ErrorText>}
          </FormGroup>

          <FormGroup>
            <Label htmlFor="priority">
              –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–ø—Ä–æ—Å–∞
            </Label>
            <Select
              id="priority"
              name="priority"
              value={formData.priority}
              onChange={handleInputChange}
            >
              <option value="low">–ù–∏–∑–∫–∏–π</option>
              <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="high">–í—ã—Å–æ–∫–∏–π</option>
            </Select>
          </FormGroup>

          <FormGroup fullWidth>
            <Label htmlFor="subject">
              –¢–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏—è <Required>*</Required>
            </Label>
            <Input
              type="text"
              id="subject"
              name="subject"
              value={formData.subject}
              onChange={handleInputChange}
              placeholder="–ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É"
              $hasError={!!errors.subject}
            />
            {errors.subject && <ErrorText>{errors.subject}</ErrorText>}
          </FormGroup>

          <FormGroup fullWidth>
            <Label htmlFor="message">
              –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ <Required>*</Required>
            </Label>
            <TextArea
              id="message"
              name="message"
              value={formData.message}
              onChange={handleInputChange}
              placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ..."
              rows={6}
              $hasError={!!errors.message}
            />
            {errors.message && <ErrorText>{errors.message}</ErrorText>}
            <CharCount>
              {formData.message.length} / 1000 —Å–∏–º–≤–æ–ª–æ–≤
            </CharCount>
          </FormGroup>
        </FormGrid>

        <SubmitButton 
          type="submit" 
          disabled={isSubmitting}
        >
          {isSubmitting ? (
            <>
              <ButtonSpinner />
              –û—Ç–ø—Ä–∞–≤–∫–∞...
            </>
          ) : (
            '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å'
          )}
        </SubmitButton>

        <FormFooter>
          <FooterText>
            <Required>*</Required> –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
          </FooterText>
          <ResponseTime>
            ‚è± –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 2-4 —á–∞—Å–∞
          </ResponseTime>
        </FormFooter>
      </SupportFormContainer>

      <SupportInfo>
        <InfoCard>
          <InfoIcon>üìß</InfoIcon>
          <InfoContent>
            <InfoTitle>Email –ø–æ–¥–¥–µ—Ä–∂–∫–∞</InfoTitle>
            <InfoText>support@gifts-store.com</InfoText>
          </InfoContent>
        </InfoCard>

        <InfoCard>
          <InfoIcon>üïí</InfoIcon>
          <InfoContent>
            <InfoTitle>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</InfoTitle>
            <InfoText>–ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ, 7 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é</InfoText>
          </InfoContent>
        </InfoCard>

        <InfoCard>
          <InfoIcon>üìû</InfoIcon>
          <InfoContent>
            <InfoTitle>–¢–µ–ª–µ—Ñ–æ–Ω</InfoTitle>
            <InfoText>+7 (900) 123-45-67</InfoText>
          </InfoContent>
        </InfoCard>
      </SupportInfo>
    </SupportContainer>
  );
};

export default SupportPage;

// Animations
const fadeIn = keyframes`
  from { 
    opacity: 0; 
    transform: translateY(30px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
`;

const spin = keyframes`
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
`;

const pulse = keyframes`
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
`;

// Styles
const SupportContainer = styled.div`
  max-width: 800px;
  margin: 0 auto;
  animation: ${fadeIn} 0.6s ease-out;
`;

const SupportHeader = styled.div`
  text-align: center;
  margin-bottom: 40px;
`;

const SupportTitle = styled.h1`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 32px;
  margin: 0 0 16px 0;
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
`;

const SupportSubtitle = styled.p`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  line-height: 1.5;
  margin: 0;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
`;

const SupportFormContainer = styled.form`
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 40px;
  backdrop-filter: blur(10px);
`;

const FormGrid = styled.div`
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 32px;

  @media (max-width: 768px) {
    grid-template-columns: 1fr;
    gap: 20px;
  }
`;

const FormGroup = styled.div<{ fullWidth?: boolean }>`
  display: flex;
  flex-direction: column;
  grid-column: ${props => props.fullWidth ? '1 / -1' : 'auto'};
`;

const Label = styled.label`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
`;

const Required = styled.span`
  color: #ff4757;
  margin-left: 4px;
`;

const Input = styled.input<{ $hasError?: boolean }>`
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid ${props => props.$hasError ? '#ff4757' : 'rgba(255, 255, 255, 0.2)'};
  border-radius: 10px;
  padding: 12px 16px;
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  transition: all 0.3s ease;

  &:focus {
    outline: none;
    border-color: ${props => props.$hasError ? '#ff4757' : '#88FB47'};
    box-shadow: 0 0 0 2px ${props => props.$hasError ? 'rgba(255, 71, 87, 0.2)' : 'rgba(136, 251, 71, 0.2)'};
  }

  &::placeholder {
    color: #737591;
  }
`;

const Select = styled.select`
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 12px 16px;
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  transition: all 0.3s ease;
  cursor: pointer;

  &:focus {
    outline: none;
    border-color: #88FB47;
    box-shadow: 0 0 0 2px rgba(136, 251, 71, 0.2);
  }

  option {
    background: #1a1a2e;
    color: #fff;
  }
`;

const TextArea = styled.textarea<{ $hasError?: boolean }>`
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid ${props => props.$hasError ? '#ff4757' : 'rgba(255, 255, 255, 0.2)'};
  border-radius: 10px;
  padding: 12px 16px;
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  transition: all 0.3s ease;
  resize: vertical;
  min-height: 120px;

  &:focus {
    outline: none;
    border-color: ${props => props.$hasError ? '#ff4757' : '#88FB47'};
    box-shadow: 0 0 0 2px ${props => props.$hasError ? 'rgba(255, 71, 87, 0.2)' : 'rgba(136, 251, 71, 0.2)'};
  }

  &::placeholder {
    color: #737591;
  }
`;

const CharCount = styled.span`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
  margin-top: 4px;
  text-align: right;
`;

const ErrorText = styled.span`
  color: #ff4757;
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
  margin-top: 4px;
`;

const SubmitButton = styled.button`
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  border: none;
  border-radius: 10px;
  padding: 16px 32px;
  color: white;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  margin-bottom: 20px;

  &:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(136, 251, 71, 0.3);
    animation: ${pulse} 0.5s ease-in-out;
  }

  &:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
`;

const ButtonSpinner = styled.div`
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid white;
  border-radius: 50%;
  animation: ${spin} 1s linear infinite;
`;

const FormFooter = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;

  @media (max-width: 768px) {
    flex-direction: column;
    align-items: flex-start;
  }
`;

const FooterText = styled.span`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
`;

const ResponseTime = styled.span`
  color: #F89D09;
  font-family: "ChakraPetch-Regular";
  font-size: 12px;
  font-weight: 600;
`;

const SupportInfo = styled.div`
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
`;

const InfoCard = styled.div`
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.3s ease;

  &:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
  }
`;

const InfoIcon = styled.div`
  font-size: 32px;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(136, 251, 71, 0.1);
  border-radius: 12px;
`;

const InfoContent = styled.div`
  flex: 1;
`;

const InfoTitle = styled.h3`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  margin: 0 0 4px 0;
`;

const InfoText = styled.p`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  margin: 0;
`;

// Success Message Styles
const SuccessMessage = styled.div`
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 20px;
  padding: 60px 40px;
  text-align: center;
  backdrop-filter: blur(10px);
  animation: ${fadeIn} 0.6s ease-out;
`;

const SuccessIcon = styled.div`
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #88FB47 0%, #27C151 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  color: white;
  margin: 0 auto 24px;
  animation: ${pulse} 2s infinite;
`;

const SuccessTitle = styled.h2`
  color: #fff;
  font-family: "ChakraPetch-Regular";
  font-size: 28px;
  margin: 0 0 16px 0;
`;

const SuccessText = styled.p`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 16px;
  line-height: 1.6;
  margin: 0 0 32px 0;
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
`;

const SuccessDetails = styled.div`
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 32px;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
`;

const DetailItem = styled.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;

  &:last-child {
    margin-bottom: 0;
  }
`;

const DetailLabel = styled.span`
  color: #737591;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
`;

const DetailValue = styled.span`
  color: #88FB47;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
`;

const NewTicketButton = styled.button`
  background: transparent;
  border: 1px solid #88FB47;
  border-radius: 10px;
  padding: 12px 24px;
  color: #88FB47;
  font-family: "ChakraPetch-Regular";
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    background: rgba(136, 251, 71, 0.1);
    transform: translateY(-2px);
  }
`;


/games-stuff-shop/src/services/cardlink.service.ts:
// frontend/src/services/cardlink.service.ts
import { userApi } from '../api/user.api';

// const API_BASE_URL = 'http://localhost:5000/api';
const API_BASE_URL = '/api';

export interface CardLinkPaymentResponse {
  success: boolean;
  link_url?: string;
  link_page_url?: string;
  bill_id?: string;
  error?: string;
}

export interface PaymentStatusResponse {
  success: boolean;
  is_paid?: boolean;
  is_failed?: boolean;
  is_processing?: boolean;
  status?: string;
  error?: string;
}

class CardLinkService {
  async createPayment(
    amount: number,
    orderId: string,
    description: string,
    userId: number
  ): Promise<CardLinkPaymentResponse> {
    try {
      const response = await fetch(`${API_BASE_URL}/cardlink/create-payment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          amount,
          order_id: orderId,
          description,
          user_id: userId,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.status === 'success') {
        return result.data;
      } else {
        return {
          success: false,
          error: result.message
        };
      }
    } catch (error) {
      console.error('Error creating payment:', error);
      return {
        success: false,
        error: 'Failed to create payment'
      };
    }
  }

  async checkPaymentStatus(billId: string): Promise<PaymentStatusResponse> {
    try {
      const response = await fetch(`${API_BASE_URL}/cardlink/check-status?bill_id=${billId}`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();
      
      if (result.status === 'success') {
        return result.data;
      } else {
        return {
          success: false,
          error: result.message
        };
      }
    } catch (error) {
      console.error('Error checking payment status:', error);
      return {
        success: false,
        error: 'Failed to check payment status'
      };
    }
  }

  async verifyPaymentAndUpdateBalance(billId: string, userId: number, amount: number): Promise<boolean> {
    try {
      const status = await this.checkPaymentStatus(billId);
      
      if (status.success && status.is_paid) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π API
        const balanceUpdate = {
          amount: amount,
          payment_method: 'cardlink',
        };

        await userApi.updateBalance(userId, balanceUpdate);
        return true;
      }
      
      return false;
    } catch (error) {
      console.error('Error verifying payment:', error);
      return false;
    }
  }
}

export const cardLinkService = new CardLinkService();


/games-stuff-shop/src/services/orderService.ts:
import type { CartItem } from '../context/CartContext';

export interface CreateOrderRequest {
  service_id: number;
  quantity: number;
  data?: string;
  user_id: number;
  service_name: string;
  price: number;
}

export interface CreateOrderResponse {
  custom_id: string;
  status: number;
  service_id: number;
  quantity: number;
  total: number;
  date: string;
  service_name: string;
  user_id: number;
}

export interface PayOrderRequest {
  custom_id: string;
  user_id: number;
}

export interface PayOrderResponse {
  message: string;
  custom_id: string;
  status: number;
}

export interface OrderInfoRequest {
  custom_id: string;
}

export interface OrderInfoResponse {
  custom_id: string;
  status: number;
  status_message: string;
  product: string;
  quantity: number;
  total_price: number;
  data?: string;
  pins?: string[];
}

export interface CheckoutRequest {
  user_id: number;
  items: CartItem[];
}

export interface CheckoutItemResult {
  success: boolean;
  custom_id: string;
  service_id: number;
  service_name: string;
  status: number;
  status_message: string;
  pins?: string[];
  data?: string;
  error?: string;
}

export interface CheckoutResponse {
  status: string;
  data: {
    results: CheckoutItemResult[];
    total_processed: number;
    total_failed: number;
    total_amount: number;
  };
  message?: string;
}

// –¢–∏–ø—ã –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ API
interface ApiResponse<T> {
  status: string;
  data?: T;
  message?: string;
}

class OrderService {
  // private baseUrl = 'http://localhost:5000/api';
  private baseUrl = '/api'

  private async handleApiRequest<T>(
    url: string, 
    options: RequestInit
  ): Promise<T> {
    try {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...options.headers,
        },
      });

      if (!response.ok) {
        const errorText = await response.text();
        let errorMessage = `HTTP error! status: ${response.status}`;
        
        try {
          const errorData = JSON.parse(errorText);
          errorMessage = errorData.message || errorMessage;
        } catch {
          errorMessage = errorText || errorMessage;
        }
        
        throw new Error(errorMessage);
      }

      const result: ApiResponse<T> = await response.json();
      
      if (result.status !== 'success') {
        throw new Error(result.message || 'API request failed');
      }

      return result.data as T;
    } catch (error) {
      if (error instanceof Error) {
        throw error;
      }
      throw new Error('Unknown error occurred');
    }
  }

  async createOrder(orderData: CreateOrderRequest): Promise<CreateOrderResponse> {
    return this.handleApiRequest<CreateOrderResponse>(
      `${this.baseUrl}/gifts/create-order`,
      {
        method: 'POST',
        body: JSON.stringify(orderData),
      }
    );
  }

  async payOrder(payData: PayOrderRequest): Promise<PayOrderResponse> {
    return this.handleApiRequest<PayOrderResponse>(
      `${this.baseUrl}/gifts/pay-order`,
      {
        method: 'POST',
        body: JSON.stringify(payData),
      }
    );
  }

  async getOrderInfo(custom_id: string): Promise<OrderInfoResponse> {
    return this.handleApiRequest<OrderInfoResponse>(
      `${this.baseUrl}/gifts/order-info`,
      {
        method: 'POST',
        body: JSON.stringify({ custom_id }),
      }
    );
  }

  async checkout(checkoutData: CheckoutRequest): Promise<CheckoutResponse> {
    return this.handleApiRequest<CheckoutResponse>(
      `${this.baseUrl}/gifts/checkout`,
      {
        method: 'POST',
        body: JSON.stringify(checkoutData),
      }
    );
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  async createAndPayOrder(orderData: CreateOrderRequest): Promise<{
    createResponse: CreateOrderResponse;
    payResponse: PayOrderResponse;
    orderInfo: OrderInfoResponse;
  }> {
    try {
      // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
      const createResponse = await this.createOrder(orderData);
      
      // –û–ø–ª–∞—á–∏–≤–∞–µ–º –∑–∞–∫–∞–∑
      const payResponse = await this.payOrder({
        custom_id: createResponse.custom_id,
        user_id: orderData.user_id,
      });
      
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ
      const orderInfo = await this.getOrderInfo(createResponse.custom_id);
      
      return {
        createResponse,
        payResponse,
        orderInfo,
      };
    } catch (error) {
      throw new Error(`Failed to create and pay order: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  async checkMultipleOrdersStatus(customIds: string[]): Promise<OrderInfoResponse[]> {
    const promises = customIds.map(async (customId) => {
      try {
        return await this.getOrderInfo(customId);
      } catch (error) {
        console.error(`Failed to get info for order ${customId}:`, error);
        return null;
      }
    });

    const results = await Promise.all(promises);
    return results.filter((result): result is OrderInfoResponse => result !== null);
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∑–∞–∫–∞–∑–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
  async waitForOrderCompletion(
    customId: string, 
    maxAttempts: number = 10, 
    delay: number = 2000
  ): Promise<OrderInfoResponse> {
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        const orderInfo = await this.getOrderInfo(customId);
        
        // –°—Ç–∞—Ç—É—Å 2 –æ–∑–Ω–∞—á–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑
        if (orderInfo.status === 2) {
          return orderInfo;
        }
        
        // –°—Ç–∞—Ç—É—Å 3 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—à–∏–±–∫—É
        if (orderInfo.status === 3) {
          throw new Error(`Order failed: ${orderInfo.status_message}`);
        }
        
        // –ï—Å–ª–∏ –∑–∞–∫–∞–∑ –µ—â–µ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ, –∂–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
        if (attempt < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      } catch (error) {
        if (attempt === maxAttempts) {
          throw new Error(`Failed to complete order after ${maxAttempts} attempts: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
      }
    }
    
    throw new Error(`Order timed out after ${maxAttempts} attempts`);
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞
  validateOrderData(orderData: CreateOrderRequest): string | null {
    if (!orderData.service_id || orderData.service_id <= 0) {
      return 'Invalid service ID';
    }
    
    if (!orderData.quantity || orderData.quantity <= 0) {
      return 'Invalid quantity';
    }
    
    if (!orderData.user_id || orderData.user_id <= 0) {
      return 'Invalid user ID';
    }
    
    if (!orderData.service_name?.trim()) {
      return 'Service name is required';
    }
    
    if (!orderData.price || orderData.price <= 0) {
      return 'Invalid price';
    }
    
    return null;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞
  validateCartForCheckout(items: CartItem[]): string | null {
    if (!items || items.length === 0) {
      return 'Cart is empty';
    }

    const missingDataItems = items.filter(item => 
      this.requiresUserData(item.service_name) && (!item.userData || !item.userData.trim())
    );

    if (missingDataItems.length > 0) {
      const itemNames = missingDataItems.map(item => item.service_name).join(', ');
      return `Please provide required data for: ${itemNames}`;
    }

    const invalidItems = items.filter(item => !item.price || item.price <= 0);
    if (invalidItems.length > 0) {
      return 'Some items have invalid prices';
    }

    return null;
  }

  // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ CartItem –≤ CheckoutRequest items
  prepareCheckoutItems(items: CartItem[]): Array<{
    service_id: number;
    service_name: string;
    price: number;
    currency: string;
    quantity: number;
    data?: string;
  }> {
    return items.map(item => ({
      service_id: item.service_id,
      service_name: item.service_name,
      price: item.price || 0,
      currency: item.currency || 'USD',
      quantity: item.quantity,
      data: item.userData || undefined,
    }));
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  requiresUserData(serviceName: string): boolean {
    const lowerName = serviceName.toLowerCase();
    return lowerName.includes('steam') || 
           lowerName.includes('account') || 
           lowerName.includes('login') ||
           lowerName.includes('–∞–∫–∫–∞—É–Ω—Ç') ||
           lowerName.includes('–ª–æ–≥–∏–Ω');
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ –≤ —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
  getOrderStatusText(status: number): string {
    switch (status) {
      case 1: return 'Pending';
      case 2: return 'Completed';
      case 3: return 'Failed';
      default: return 'Unknown';
    }
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
  getOrderStatusColor(status: number): string {
    switch (status) {
      case 2: return '#88FB47'; // Green for completed
      case 3: return '#ff3b3b'; // Red for failed
      case 1: return '#F89D09'; // Orange for pending
      default: return '#737591'; // Gray for unknown
    }
  }

  // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—É–º–º—ã –∑–∞–∫–∞–∑–∞
  calculateOrderTotal(items: CartItem[]): number {
    return items.reduce((total, item) => {
      const price = item.price || 0;
      return total + (price * item.quantity);
    }, 0);
  }


  async getOrderInfoByCustomId(custom_id: string): Promise<OrderInfoResponse> {
    const response = await fetch(`${this.baseUrl}/gifts/order-info-by-custom-id`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ custom_id }),
    });

    if (!response.ok) {
      throw new Error(`Failed to get order info: ${response.statusText}`);
    }

    const result = await response.json();
    return result.data;
  }
}

export const orderService = new OrderService();


/games-stuff-shop/src/types/api.types.ts:
export interface GiftCategory {
  category_id: number;
  category_name: string;
  category_description?: string;
}

export interface GiftsCategories {
  data: GiftCategory[];
}

export interface CategoryWithImage {
  id: number;
  name: string;
  image: string;
  count: number;
  tags: string[];
  tagIDs: number[];
}

export interface ServiceItem {
  service_id: number;
  service_name: string;
  service_description?: string;
  price?: number;
  currency?: string;
  available?: boolean;
  // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ —Å API
  category_id?: number;
  service_image?: string;
  min_price?: number;
  max_price?: number;
  in_stock?: number;
}

export interface ServicesResponse {
  data: ServiceItem[];
}

export interface User {
  id: number;
  username: string;
  email: string;
  balance: number;
  total_spent: number;
  join_date: string;
  created_at: string;
  updated_at: string;
}

export interface Purchase {
  id: number;
  user_id: number;
  service_id: number;
  service_name: string;
  amount: number;
  currency: string;
  status: 'completed' | 'pending' | 'failed';
  purchase_date: string;
  created_at: string;
  custom_id?: string; // –î–æ–±–∞–≤–ª—è–µ–º custom_id
}

export interface UserProfile {
  user: User;
  purchases: Purchase[];
  totalPurchases: number;
  successfulTransactions: number;
}

export interface BalanceUpdateRequest {
  amount: number;
  payment_method: string;
  payment_details?: any;
}

// ========== –ù–û–í–´–ï –¢–ò–ü–´ –î–õ–Ø –ó–ê–ö–ê–ó–û–í ==========

export interface CreateOrderRequest {
  service_id: number;
  quantity: number;
  data?: string;
  user_id: number;
  service_name: string;
  price: number;
}

export interface CreateOrderResponse {
  custom_id: string;
  status: number;
  service_id: number;
  quantity: number;
  total: number;
  date: string;
  service_name: string;
  user_id: number;
}

export interface PayOrderRequest {
  custom_id: string;
  user_id: number;
}

export interface PayOrderResponse {
  message: string;
  custom_id: string;
  status: number;
}

export interface OrderInfoRequest {
  custom_id: string;
}

export interface OrderInfoResponse {
  custom_id: string;
  status: number;
  status_message: string;
  product: string;
  quantity: number;
  total_price: number;
  data?: string;
  pins?: string[];
}

export interface CheckoutItem {
  service_id: number;
  service_name: string;
  price: number;
  currency: string;
  quantity: number;
  data?: string;
}

export interface CheckoutRequest {
  user_id: number;
  items: CheckoutItem[];
}

export interface CheckoutItemResult {
  success: boolean;
  custom_id: string;
  service_id: number;
  service_name: string;
  status: number;
  status_message: string;
  pins?: string[];
  data?: string;
  error?: string;
}

export interface CheckoutResponseData {
  results: CheckoutItemResult[];
  total_processed: number;
  total_failed: number;
  total_amount: number;
}

export interface CheckoutResponse {
  status: string;
  data: CheckoutResponseData;
  message?: string;
}

// –¢–∏–ø—ã –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ API
export interface ApiResponse<T> {
  status: string;
  data?: T;
  message?: string;
}

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ (–≤–º–µ—Å—Ç–æ enum)
export const ORDER_STATUS = {
  PENDING: 1,
  COMPLETED: 2,
  FAILED: 3
} as const;

export type OrderStatus = typeof ORDER_STATUS[keyof typeof ORDER_STATUS];

// –¢–∏–ø –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—É–ø–∫–µ (—Å PIN –∫–æ–¥–∞–º–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏)
export interface ExtendedPurchase extends Purchase {
  custom_id?: string;
  pins?: string[];
  user_data?: string;
  quantity?: number;
}

// –¢–∏–ø—ã –¥–ª—è —Ñ–æ—Ä–º –∏ UI
export interface CartItem extends ServiceItem {
  quantity: number;
  userData?: string;
}

export interface CheckoutFormData {
  userId: number;
  items: CartItem[];
}


/games-stuff-shop/src/utils/categoryMapper.ts:
// utils/categoryMapper.ts
export const categoryImageMap: Record<string, string> = {
  'Steam': 'steam',
  'Valorant': 'valorant',
  'Apple': 'apple',
  'Nintendo': 'nintendo_gift',
  'Apex Legends': 'ea_gift',
  'Games': 'games_pc_mac',
  'Xbox': 'xbox_gift',
  'Roblox': 'roblox_global',
  'Playstation': 'playstation_gift',
  'Blizzard': 'blizzard_gift',
  'Free Fire': 'games_pc_mac',
  'Mobile Legends': 'games_pc_mac',
  'Google Play': 'google_play_gift',
  'Twitch': 'social_network',
  'EA': 'ea_gift',
  'Meta Quest': 'games_pc_mac',
  'Battlefield': 'ea_gift',
  'Destiny': 'games_pc_mac',
  'Mafia': 'games_pc_mac',
  'Minecraft': 'games_pc_mac',
  'Plants vs. Zombies': 'ea_gift',
  'The Elder Scrolls': 'games_pc_mac',
  'Tom Clancy': 'games_pc_mac',
  'Warhammer': 'games_pc_mac',
  'Halo': 'xbox_games',
  'DOOM': 'games_pc_mac',
  'Indiana Jones': 'games_pc_mac',
  'Killing Floor': 'games_pc_mac',
  'Kingdom Come': 'games_pc_mac',
  'Lost in Random': 'games_pc_mac',
  'Ready or Not': 'games_pc_mac',
  'REMATCH': 'games_pc_mac',
  'Delta Force': 'games_pc_mac',
  'Doomsday': 'games_pc_mac',
  'Honor of Kings': 'games_pc_mac',
  'Lords Mobile': 'games_pc_mac',
  'Undawn': 'games_pc_mac',
  'The Sims': 'ea_gift',
  'Split Fiction': 'ea_gift',
  'Netflix': 'music_streaming',
  'Spotify': 'music_streaming',
  'Pubg Mobile': 'games_pc_mac',
  'Test': 'games_pc_mac'
};


/games-stuff-shop/src/utils/categoryUtils.ts:
// utils/categoryUtils.ts
import type { GiftCategory } from '../types/api.types';
import { categoryImageMap } from './categoryMapper';

export const groupCategories = (categories: GiftCategory[]) => {
  const grouped: Record<string, { id: number, name: string, count: number, tags: string[], tagIDs: number[] }> = {};

  categories.forEach(category => {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—É–±–∏—Ä–∞–µ–º —Ä–µ–≥–∏–æ–Ω—ã –∏ –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)
    let mainCategory = category.category_name.split('|')[0].trim();
    mainCategory = mainCategory.split('|')[0].trim(); // –ù–∞ —Å–ª—É—á–∞–π –¥–≤–æ–π–Ω—ã—Ö |
    mainCategory = mainCategory.split('/')[0].trim(); // –ù–∞ —Å–ª—É—á–∞–π —Å–ª–µ—à–µ–π

    let addCategory = category.category_name.split('|')[1];
    if (addCategory) {
      addCategory = addCategory.trim();
    }
    
    let addCategoryID = category.category_id;
    if (addCategory) {
      addCategory = addCategory.trim();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
    if (mainCategory.includes('Steam')) mainCategory = 'Steam';
    else if (mainCategory.includes('Xbox')) mainCategory = 'Xbox';
    else if (mainCategory.includes('PlayStation') || mainCategory.includes('Playstation')) mainCategory = 'Playstation';
    else if (mainCategory.includes('Google Play')) mainCategory = 'Google Play';
    else if (mainCategory.includes('Apple')) mainCategory = 'Apple';
    else if (mainCategory.includes('Valorant')) mainCategory = 'Valorant';
    else if (mainCategory.includes('Roblox')) mainCategory = 'Roblox';
    else if (mainCategory.includes('Blizzard')) mainCategory = 'Blizzard';
    else if (mainCategory.includes('Nintendo')) mainCategory = 'Nintendo';
    else if (mainCategory.includes('Netflix')) mainCategory = 'Netflix';
    else if (mainCategory.includes('Spotify')) mainCategory = 'Spotify';
    else if (mainCategory.includes('EA')) mainCategory = 'EA';
    else if (mainCategory.includes('Meta Quest')) mainCategory = 'Meta Quest';
    else if (mainCategory.includes('Twitch')) mainCategory = 'Twitch';

    if (!grouped[mainCategory]) {
      grouped[mainCategory] = {
        id: category.category_id,
        name: mainCategory,
        count: 0,
        tags: [],
        tagIDs: []
      };
    }
    grouped[mainCategory].count++;
    if (addCategory) {
      grouped[mainCategory].tags.push(addCategory);
      grouped[mainCategory].tagIDs.push(addCategoryID);
    }
  });

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
  return Object.values(grouped).map(group => ({
    ...group,
    image: categoryImageMap[group.name] || 'games_pc_mac' // fallback image
  }));
};


/games-stuff-shop/src/utils/countryFlags.tsx:
// utils/countryFlags.tsx
import React from 'react';
import Flag from 'react-world-flags';

interface FlagComponentProps {
  countryCode: string;
  size?: number;
  className?: string;
}

export const getCountryFlag = (countryCode: string): React.ReactElement => {
  const countryMap: Record<string, string> = {
    'USA': 'US', 'US': 'US',
    'RU': 'RU', 'TR': 'TR', 'EU': 'EU', 'UK': 'GB',
    'PL': 'PL', 'DE': 'DE', 'FR': 'FR', 'IT': 'IT',
    'ES': 'ES', 'BR': 'BR', 'JP': 'JP', 'IN': 'IN',
    'CA': 'CA', 'AU': 'AU', 'CN': 'CN', 'KR': 'KR',
    'MX': 'MX', 'AE': 'AE', 'SA': 'SA', 'QA': 'QA',
    'KW': 'KW', 'HK': 'HK', 'SG': 'SG', 'MY': 'MY',
    'ID': 'ID', 'TH': 'TH', 'VN': 'VN', 'PH': 'PH',
    'GLOB': 'UN', // –ì–ª–æ–±–∞–ª—å–Ω—ã–π - —Ñ–ª–∞–≥ –û–û–ù
    'CIS': 'RU', // –°–ù–ì - —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–ª–∞–≥ –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π
    'LATAM': 'MX', // –õ–∞—Ç–∏–Ω—Å–∫–∞—è –ê–º–µ—Ä–∏–∫–∞ - –º–µ–∫—Å–∏–∫–∞–Ω—Å–∫–∏–π —Ñ–ª–∞–≥
    'PT': 'PT', 'IE': 'IE', 'BE': 'BE',
    'TRY': 'TR',
    'ZAR': 'ZA',
    'ZA': 'ZA',
    'HU': 'EG',
    'CO': 'CO',
    'PLN': 'PL',
    'INR': 'IN',
    'AT': 'AT',
    'BH': 'BH',
    'CZ': 'CZ',
    'FI': 'FI',
    'GR': 'GR',
    'HR': 'HR',
    'LB': 'LB',
    'LU': 'LU',
    'NL': 'NL',
    'NZ': 'NZ',
    'OM': 'OM',
    'RO': 'RO',
    'SK': 'SK',
    'DZ': 'DZ',
    'ROW': 'RO'
  };

  const code = countryMap[countryCode] || 'UN';
  
  return (
    <Flag 
      code={code} 
      width={24} 
      height={18}
      style={{ borderRadius: '2px' }}
    />
  );
};

// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
export const CountryFlag: React.FC<FlagComponentProps> = ({ 
  countryCode, 
  size = 24,
  className = ""
}) => {
  const countryMap: Record<string, string> = {
    'USA': 'US', 'US': 'US',
    'RU': 'RU', 'TR': 'TR', 'EU': 'EU', 'UK': 'GB',
    'PL': 'PL', 'DE': 'DE', 'FR': 'FR', 'IT': 'IT',
    'ES': 'ES', 'BR': 'BR', 'JP': 'JP', 'IN': 'IN',
    'CA': 'CA', 'AU': 'AU', 'CN': 'CN', 'KR': 'KR',
    'MX': 'MX', 'AE': 'AE', 'SA': 'SA', 'QA': 'QA',
    'KW': 'KW', 'HK': 'HK', 'SG': 'SG', 'MY': 'MY',
    'ID': 'ID', 'TH': 'TH', 'VN': 'VN', 'PH': 'PH',
    'GLOB': 'UN',
    'CIS': 'RU',
    'LATAM': 'MX',
    'PT': 'PT', 'IE': 'IE', 'BE': 'BE',
    'USD': 'USA',
    'TRY': 'TR',
    'ZAR': 'ZA',
    'ZA': 'ZA',
    'HU': 'EG',
    'CO': 'CO',
    'PLN': 'PL',
    'INR': 'IN',
    'AT': 'AT',
    'BH': 'BH',
    'CZ': 'CZ',
    'FI': 'FI',
    'GR': 'GR',
    'HR': 'HR',
    'LB': 'LB',
    'LU': 'LU',
    'NL': 'NL',
    'NZ': 'NZ',
    'OM': 'OM',
    'RO': 'RO',
    'SK': 'SK',
    'DZ': 'DZ',
    'ROW': 'RO'
  };

  const code = countryMap[countryCode] || 'UN';
  
  return (
    <Flag 
      code={code} 
      width={size}
      height={size * 0.75}
      className={className}
      style={{ 
        borderRadius: '3px',
        objectFit: 'cover'
      }}
    />
  );
};


/games-stuff-shop/src/App.tsx:
// App.tsx
import React from 'react';
import { BrowserRouter as Router } from 'react-router-dom';
import HeaderNavigation from "./components/HeaderNavigation.tsx";
import Navigation from './components/Navigation.tsx';
import AppRoutes from './components/AppRoutes.tsx';
import styled from 'styled-components';
import { CartProvider } from './context/CartContext';
import { UserProvider } from './context/UserContext';

const App: React.FC = () => {
  return (
    <UserProvider>
      <CartProvider>
        <Router>
          <AppWindow>
            <HeaderNavigation />
            <main className="main-content">
              <AppRoutes />
            </main>
            <Navigation />
          </AppWindow>
        </Router>
      </CartProvider>
    </UserProvider>
  );
};

export default App;

// Styles (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
const AppWindow = styled.div`
  width: 100%;
  height: 100%;
  max-width: 1200px;
  min-width: 200px;
  min-height: 400px;

  display: flex;
  flex-direction: column;

  & .main-content {
    padding-top: 100px;
    padding-bottom: 100px;
    box-sizing: border-box;
  }
`


/games-stuff-shop/src/Main.tsx:
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
    <App />
)



/games-stuff-shop/Dockerfile:
FROM node:18-alpine as build

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ package-lock.json
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm install

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
RUN npm run build

# –°—Ç–∞–¥–∏—è production
FROM nginx:alpine

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ nginx
COPY --from=build /app/dist /usr/share/nginx/html

# –ö–æ–ø–∏—Ä—É–µ–º nginx –∫–æ–Ω—Ñ–∏–≥
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]


/games-stuff-shop/index.html:
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OSManov-Shop</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>



/games-stuff-shop/nginx.conf:
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html index.htm;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}


/games-stuff-shop/vite.config.js:
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  base: '/',
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    assetsInlineLimit: 0
  },
  server: {
    host: true,
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true,
        secure: false
      }
    }
  }
})


